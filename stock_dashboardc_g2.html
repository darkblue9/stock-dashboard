<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ë§ˆë…€ì˜ ì£¼ì‹ ëŒ€ì‹œë³´ë“œ v7.2 (ì‹¤ìˆ˜ë°©ì§€ ê¸°ëŠ¥)</title>
<style>
/* === ê¸°ë³¸ ìŠ¤íƒ€ì¼ (13px ìœ ì§€) === */
body{font-family:sans-serif; margin:10px; font-size:13px;}
table{width:100%; border-collapse:collapse; table-layout:fixed; margin-top:5px;}
/* ì…€ ì¢Œìš° ì—¬ë°±ì„ ì¤„ì—¬ì„œ ê³µê°„ í™•ë³´ (padding: 3px 1px) */
th,td{border:1px solid #ccc; padding:3px 1px; text-align:center; vertical-align:middle; height: 34px;}
input,select,button{font:inherit; font-size:13px;}

/* === ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ === */
#grid td > input { width: 100%; padding: 2px 2px; box-sizing: border-box; text-align: right; border:none; background: transparent; height: 26px; line-height: 22px;}
#grid td > input:focus { background: #fff; outline: 2px solid #aaa; }
#grid td input.name { text-align: left; font-weight: bold; }
#grid td input.code { text-align: center; color: #666; font-size: 12px; }

/* ë‚ ì§œ ì…€ ìŠ¤íƒ€ì¼ (í°íŠ¸ 11pxë¡œ ìœ ì§€í•˜ë˜ í­ ë§ì¶¤) */
#grid td input[type="date"] { 
    font-size: 11px; text-align: center; height: 24px; padding: 0; letter-spacing: -1px; width: 100%;
}

td input[readonly]{background:#f9f9f9; color:#555}
.status{font-size:12px; font-weight:bold;}
.profit-pos{color:#d32f2f; font-weight:bold}
.profit-neg{color:#1976d2; font-weight:bold}

/* === ë²„íŠ¼ ë° ì•¡ì…˜ === */
.actions{display:inline-flex; align-items:center; gap:2px; white-space:nowrap; justify-content:center}
.mv{display:inline-flex; gap:1px}
.mv button, .del, .chart-btn {
    width: 24px; height: 24px; font-size: 12px; padding: 0; 
    cursor:pointer; border:1px solid #999; background:#eee; border-radius:3px;
}
.del{ width:auto; padding:0 6px; background:#ffebee; border-color:#ef9a9a; color:#c62828; }
.chart-btn{ width:auto; padding:0 6px; background:#e3f2fd; border-color:#90caf9; color:#1565c0; }
#resetBtn { background: #333; color: #fff; border: 1px solid #000; font-weight: bold; padding: 4px 8px; font-size: 12px;}

/* === ëª©í‘œê°€ ì  === */
.dot{width:6px; height:6px; border-radius:50%; background:#ccc; display:inline-block; flex-shrink:0;}
.dot.red{background:#ff1744}
.dot.blue{background:#2979ff}
.target-cell{display:flex; align-items:center; gap:2px; justify-content:center; width:100%;}
.target-cell input { flex: 1; min-width: 0; font-size: 12px; }

/* === ìƒë‹¨ í•„í„° ë°” === */
.filter-bar { margin: 8px 0; display:flex; gap: 6px; align-items: center; padding: 6px; background: #f4f4f4; border-radius: 6px; border: 1px solid #ddd; flex-wrap:wrap; }
.filter-label { font-weight: bold; margin-right: 4px; font-size: 13px;}
.filter-btn { padding: 5px 10px; border: 1px solid #bbb; background: #fff; cursor: pointer; border-radius: 4px; font-size: 12px;}
.filter-btn.active { background: #424242; color: #fff; border-color: #000; font-weight: bold;}

/* === ê·¸ë£¹ ë°°ì§€ ë²„íŠ¼ === */
.grp-btn { width: 26px; height: 22px; font-size: 11px; font-weight:bold; border:1px solid rgba(0,0,0,0.2); border-radius: 4px; cursor:pointer; padding:0;}
.grp-short { background: #ffebee; color: #c62828; } 
.grp-long  { background: #e3f2fd; color: #1565c0; }

/* === ìƒíƒœ ë°°ì§€ === */
.status-badge { display:inline-block; padding:2px 4px; border-radius:4px; color:#fff; font-size:11px; line-height:1.2; font-weight:normal; min-width: 32px;}
.st-active { background:#00897b; } /* ìš´ì˜ì¤‘ */
.st-sold { background:#757575; }   /* ë§¤ë„ë¨ */
.st-watch { background:#fff; color:#999; border:1px solid #ddd; } /* ê´€ë§ */

/* === í† ìŠ¤íŠ¸, ìƒë‹¨ ë°°ì§€ === */
.top-total{position:fixed; top:50px; right:15px; z-index:6; background:#fff; border:2px solid #ccc; padding:6px 12px; border-radius:10px; box-shadow:0 4px 14px rgba(0,0,0,.1); font-weight:bold; font-size: 14px;}
.total-pos{color:#d32f2f; border-color:#ef9a9a;} 
.total-neg{color:#1976d2; border-color:#90caf9;}

/* === íŠ¸ë Œë“œ ì  === */
td.cur-cell { position: relative; }
td.cur-cell .trend-dots { position: absolute; right: 2px; bottom: 2px; display:flex; gap:1px; pointer-events:none;} 
.trend-dot { width:5px; height:5px; border-radius:50%; background:#ddd; opacity:.5 } 
.trend-dot.up   { background:#d32f2f; opacity:1; }
.trend-dot.down { background:#1976d2; opacity:1; }

/* === D-Day ë°°ì§€ === */
.date-cell { display:flex; flex-direction:column; align-items:center; gap:0px; }
.d-day-badge { font-size:9px; font-weight:bold; color:#fff; background:#90a4ae; padding:1px 3px; border-radius:3px; display:inline-block; min-width:24px; line-height: 1.1; margin-bottom: 1px;}
.d-day-badge.new { background: #ff9800; } 
.d-day-badge.old { background: #607d8b; } 

/* === ë©”ëª¨ ê¸°ëŠ¥ === */
.row-no { cursor: pointer; position: relative; }
.row-no:hover { background-color: #e3f2fd; } 
.memo-indicator { position: absolute; top: 2px; right: 2px; width: 6px; height: 6px; background: red; border-radius: 50%; display: none;}
.row-no.has-memo .memo-indicator { display: block; }
.memo-tooltip {
    display: none; position: absolute; left: 100%; top: 0; z-index: 1000;
    background: #333; color: #fff; padding: 6px 10px; border-radius: 4px;
    font-size: 12px; width: 200px; text-align: left; white-space: pre-wrap;
    box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
}
.row-no:hover .memo-tooltip { display: block; }

/* === ì»¬ëŸ¼ í­ ì„¤ì • (ë‹¤ì´ì–´íŠ¸ ì ìš©) === */
col.col-no { width: 30px; }
col.col-group { width: 35px; }
col.col-status { width: 45px; } 
col.col-code { width: 55px; }
col.col-name { width: 90px; } 
col.col-date { width: 78px; } 
col.col-sdate { width: 78px; } 
col.col-avg { width: 65px; }
col.col-qty { width: 35px; }
col.col-inv { width: 75px; }
col.col-target { width: 85px; }
col.col-target { width: 85px; }
col.col-cur { width: 70px; } 
col.col-rate { width: 50px; }
col.col-fix { width: 70px; } 
col.col-day-profit { width: 65px; } 
col.col-profit { width: 65px; } 
col.col-percent { width: 55px; }
col.col-act { width: 150px; }

@media (max-width: 600px) {
  .actions { flex-wrap: wrap; }
  .filter-bar { flex-wrap: wrap; }
  .top-total { font-size: 12px; padding: 4px 8px; top: 45px; right: 10px; } 
}
</style>
</head>
<body>

<div>
  <details>
    <summary style="cursor:pointer; margin-bottom:6px; font-weight:bold; color:#555; font-size:13px;">âš™ï¸ ì„¤ì • (API/í”„ë¡ì‹œ)</summary>
    <div style="padding:10px; background:#f8f8f8; border:1px solid #ddd; margin-bottom:10px; border-radius: 6px;">
      <label>í”„ë¡ì‹œ <input id="apiBase" value="https://stock-dashboard.respite9.workers.dev" style="width:100%"></label><br>
      <div style="margin-top:6px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <label>ëª¨ë“œ <select id="apiMode" style="height:26px;"><option value="auto" selected>ìë™</option><option value="multi">ë©€í‹°</option><option value="single">ë‹¨ê±´</option></select></label>
        <label>Code <input id="codeParam" value="code" style="width:45px"></label>
        <label>Price <input id="priceKey" value="price" style="width:45px"></label>
        <label>ì£¼ê¸°(ì´ˆ) <input id="pollSec" type="number" value="10" min="2" style="width:45px"></label>
        <button id="resetBtn" style="margin-left:auto;">âš ï¸ë°ì´í„° ì´ˆê¸°í™”</button>
      </div>
    </div>
  </details>
  
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; flex-wrap:wrap; gap:4px;">
    <div style="display:flex; align-items:center; gap:10px;">
      <label style="font-size:14px; display:flex; align-items:center;"><input type="checkbox" id="liveToggle" checked style="margin-right:4px;"> <b>ì‹¤ì‹œê°„ ê°±ì‹ </b></label>
      <span id="status" class="status">ëŒ€ê¸°</span>
    </div>
    <div id="topTotal" class="top-total" style="position:static; margin:0; box-shadow:none; border:none; background:transparent;">ì´: 0</div>
  </div>

  <div class="filter-bar">
    <span class="filter-label">ë³´ê¸°:</span>
    <button class="filter-btn active" data-filter="short">ë‹¨íƒ€ë§Œ</button>
    <button class="filter-btn" data-filter="long">ì¥íˆ¬ë§Œ</button>
    <button class="filter-btn" data-filter="all">ì „ì²´</button>
    
    <div style="width:1px; height:20px; background:#ccc; margin:0 6px;"></div>
    
    <label style="cursor:pointer; font-weight:bold; display:flex; align-items:center; background:#fff; padding:4px 8px; border:1px solid #ccc; border-radius:4px;">
        <input type="checkbox" id="hideSoldToggle" style="margin-right:4px;"> ë§¤ë„ìˆ¨ê¹€
    </label>
    <label style="cursor:pointer; font-weight:bold; display:flex; align-items:center; background:#fff; padding:4px 8px; border:1px solid #ccc; border-radius:4px; margin-left:6px;">
        <input type="checkbox" id="hideWatchToggle" style="margin-right:4px;"> ê´€ë§ìˆ¨ê¹€
    </label>
    <label style="cursor:pointer; font-weight:bold; display:flex; align-items:center; background:#fff; padding:4px 8px; border:1px solid #ccc; border-radius:4px; margin-left:6px;">
    <input type="checkbox" id="mergeToggle" style="margin-right:4px;"> ğŸ”—ì¢…ëª©í•©ì‚°
    </label>
  </div>

  <div style="display:flex; gap:4px; flex-wrap:wrap; margin-bottom:6px;">
    <button id="addRowBtn" style="font-weight:bold; color:#1565c0; padding: 4px 10px;">+ ì¢…ëª©ì¶”ê°€</button>
    <button id="saveBtn" style="padding: 4px 10px;">ì €ì¥</button>
    <button id="cloudSaveBtn" style="padding: 4px 10px;">â˜ï¸ì €ì¥</button>
    <button id="cloudLoadBtn" style="padding: 4px 10px;">â˜ï¸ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <button id="copyTxtBtn" style="padding: 4px 10px;">ğŸ“‹ë³µì‚¬</button>
    <button id="btnSortEmptyQty" style="padding: 4px 10px;">ì •ë ¬(ìˆ˜ìµìˆœ)</button>
    <button id="btnSetTargets" style="padding: 4px 10px;">ëª©í‘œê°€ìë™</button>
  </div>
</div>

<table id="grid">
  <colgroup>
    <col class="col-no">
    <col class="col-group"> 
    <col class="col-status"> <col class="col-code">
    <col class="col-name">
    <col class="col-date"> <col class="col-sdate">
    <col class="col-avg">
    <col class="col-qty">
    <col class="col-inv">
    <col class="col-target">
    <col class="col-target">
    <col class="col-cur">
	<col class="col-rate">
    <col class="col-fix">
    <col class="col-day-profit"> <col class="col-profit">     <col class="col-percent">
    <col class="col-act">
  </colgroup>
  <thead><tr>
    <th>No</th><th>êµ¬ë¶„</th><th>ìš´ì˜<br>ìƒíƒœ</th><th>ì½”ë“œ</th><th>ì´ë¦„</th>
    <th>ë§¤ìˆ˜ì¼</th><th>ë§¤ë„ì¼</th>
    <th>ë§¤ìˆ˜ê°€</th><th>ì£¼ìˆ˜</th><th>íˆ¬ì…ê¸ˆ</th>
    <th>ìƒëª©í‘œ</th><th>í•˜ëª©í‘œ</th><th>í˜„ì¬ê°€</th><th>ì¼ì¼%</th><th>ë§¤ë„ê°€</th>
    <th>ë‹¹ì¼ì†ìµ</th><th>ëˆ„ì ì†ìµ</th><th>%</th><th>ë™ì‘</th>
  </tr></thead>
  <tbody id="tbody"></tbody>
</table>

<div style="text-align:right; margin-top:8px; font-weight:bold; font-size:14px;">
  <span id="profitLabel">ì´ ì†ìµ</span>: <span id="totalProfit" class="profit-neg">0</span> 
  | <span id="operatingLabel">ìš´ì˜ì¤‘ ì†ìµ</span>: <span id="operatingProfit" class="profit-neg">0</span> 
  (ìˆ˜ìˆ˜ë£Œ 0.26% ë°˜ì˜)
</div>

<div id="chartModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:999; align-items:center; justify-content:center;">
  <div style="background:#fff; width:95%; max-width:650px; max-height:85vh; display:flex; flex-direction:column; padding:15px; border-radius:10px; box-shadow:0 4px 15px rgba(0,0,0,0.3);">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px; flex-shrink:0;">
      <strong id="chartTitle" style="font-size:16px;">ì°¨íŠ¸</strong>
      <button onclick="document.getElementById('chartModal').style.display='none'" style="padding:4px 8px; font-size:13px;">ë‹«ê¸°</button>
    </div>
    <div style="flex:1; min-height:0; overflow:hidden;">
      <canvas id="histChart" style="width:100%; height:100%;"></canvas>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ==========================================
// 1. ìœ í‹¸ë¦¬í‹° ë° ì„¤ì •
// ==========================================
const $=(s)=>document.querySelector(s);
const $$=(s)=>document.querySelectorAll(s);
const fmt=(n)=>(n??0).toLocaleString('ko-KR');
const toNum=(v)=>Number(String(v||'').replace(/,/g,''))||0;

const FEE_BUY=0.00015, FEE_SELL=0.00015, TAX_SELL=0.00230; 
function calcProfit(avg,cur,fix,qty){
  const base=(fix && fix!==0) ? fix : cur;
  if(!avg||!qty||!base) return {won:0,pct:0};
  const buyAmt=avg*qty;
  const sellAmt=base*qty;
  const totalCost = (buyAmt * FEE_BUY) + (sellAmt * (FEE_SELL + TAX_SELL));
  const profit = sellAmt - buyAmt - totalCost;
  return {won:profit, pct: (profit/buyAmt)*100};
}

function getDDay(dateStr) {
    if(!dateStr) return '';
    const target = new Date(dateStr); target.setHours(0,0,0,0);
    const today = new Date(); today.setHours(0,0,0,0);
    const diff = (today - target) / (1000 * 60 * 60 * 24);
    const d = Math.floor(diff);
    if(d === 0) return 'D-Day';
    if(d > 0) return 'D+'+d;
    return 'D'+d; 
}

const KEY_ROWS='rows_v5_final'; 
const KEY_SET ='set_v5_final';
let rows=[], settings={};
let currentFilter = 'short'; 

// ==========================================
// 2. ë°ì´í„° ê´€ë¦¬
// ==========================================
function loadJSON(k,d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d; }catch{ return d; } }
function saveJSON(k,o){ localStorage.setItem(k, JSON.stringify(o)); }

function loadAll(){
  const savedRows = loadJSON(KEY_ROWS,[]);
  rows = savedRows.map(r => {
    if(typeof r !== 'object' || r === null) return { group: 'short' };
    return { ...r, group: r.group || 'short', memo: r.memo || '' }; 
  });
  
  settings=Object.assign({
    apiBase:'https://stock-dashboard.respite9.workers.dev', 
    apiMode:'auto', pollSec:10, codeParam:'code', priceKey:'price'
  }, loadJSON(KEY_SET,{}));
  applySettingsToUI();
}

function applySettingsToUI(){
  $('#apiBase').value = settings.apiBase;
  $('#apiMode').value = settings.apiMode;
  $('#pollSec').value = settings.pollSec;
}

function saveSettings(){
  settings.apiBase=$('#apiBase').value.trim();
  settings.apiMode=$('#apiMode').value;
  settings.pollSec=Math.max(2, Number($('#pollSec').value)||10);
  saveJSON(KEY_SET,settings);
}
function saveRows(){ saveJSON(KEY_ROWS,rows); }

// ==========================================
// 3. ë Œë”ë§
// ==========================================
function calculateDayProfitForRow(r) {
  if (!r.qty || Number(r.qty) <= 0) return 0;

  const today = new Date();
  const todayStr = today.getFullYear() + '-' + String(today.getMonth()+1).padStart(2,'0') + '-' + String(today.getDate()).padStart(2,'0');
  
  const {won} = calcProfit(r.avg, r.cur, r.fix, r.qty);

  if (r.date === todayStr) {
      return won;
  } else {
      const curPrice = r.cur || 0;
      const rate = r.dRate || 0;
      let prevClose = 0;
      if (curPrice > 0) prevClose = curPrice / (1 + rate / 100);
      
      const evalPrice = (r.fix && r.fix > 0) ? r.fix : curPrice;
      if (evalPrice > 0 && prevClose > 0) {
          return (evalPrice - prevClose) * r.qty;
      }
  }
  return 0;
}

function aggregateRows(originalRows) {
    const map = new Map();
    const result = [];
    const hideSold = $('#hideSoldToggle').checked;
    const hideWatch = $('#hideWatchToggle').checked; 

    originalRows.forEach((r, originalIndex) => {
        if(currentFilter === 'short' && r.group === 'long') return;
        if(currentFilter === 'long' && r.group === 'short') return;
        
        const isSold = (r.fix > 0);
        if(hideSold && isSold) return;

        const isWatch = (!r.qty || Number(r.qty) <= 0);
        if(hideWatch && isWatch) return;

        const statusKey = isSold ? 'SOLD' : 'ACTIVE';
        const key = r.code + '_' + r.group + '_' + statusKey; 
        
        const rowDayProfit = calculateDayProfitForRow(r);

        if (!map.has(key)) {
            map.set(key, { 
                ...r, 
                _idx: originalIndex, 
                _isAgg: false, 
                _count: 1, 
                _totalQty: Number(r.qty) || 0, 
                _totalInvest: (Number(r.avg) || 0) * (Number(r.qty) || 0),
                _totalSellAmt: (Number(r.fix) || 0) * (Number(r.qty) || 0),
                _totalDayProfit: rowDayProfit
            });
        } else {
            const entry = map.get(key);
            const curQty = Number(r.qty) || 0;
            const curInvest = (Number(r.avg) || 0) * curQty;
            const curSellAmt = (Number(r.fix) || 0) * curQty;

            entry._isAgg = true; entry._count++; 
            entry._totalQty += curQty; 
            entry._totalInvest += curInvest;
            entry._totalSellAmt += curSellAmt;
            entry._totalDayProfit += rowDayProfit;
            if (r.date < entry.date) entry.date = r.date;
            if (r.sellDate && (!entry.sellDate || r.sellDate > entry.sellDate)) {
                entry.sellDate = r.sellDate;
            }
        }
    });
    
    map.forEach(val => {
        if (val._isAgg) { 
            val.qty = val._totalQty; 
            val.avg = val._totalQty > 0 ? Math.round(val._totalInvest / val._totalQty) : 0; 
            if(val._totalSellAmt > 0 && val._totalQty > 0) {
                val.fix = Math.round(val._totalSellAmt / val._totalQty);
            }
            val.dayProfit = val._totalDayProfit;
            val.name = val.name + ` (í•©:${val._count})`; 
        }
        result.push(val);
    });
    return result.sort((a,b) => a._idx - b._idx);
}

function render(){
  const tb=$('#tbody'); 
  if(!tb) return;
  tb.innerHTML='';
  const useMerge = $('#mergeToggle').checked;
  let displayRows = [];
  if (useMerge) { displayRows = aggregateRows(rows); } 
  else {
      const hideSold = $('#hideSoldToggle').checked;
      const hideWatch = $('#hideWatchToggle').checked; 

      rows.forEach((r, i) => {
          if(currentFilter === 'short' && r.group === 'long') return;
          if(currentFilter === 'long' && r.group === 'short') return;
          
          if(hideSold && r.fix > 0) return;

          const isWatch = (!r.qty || Number(r.qty) <= 0);
          if(hideWatch && isWatch) return;

          displayRows.push({ ...r, _idx: i, _isAgg: false });
      });
  }

  let displayIdx = 0;
  displayRows.forEach((r) => {
    displayIdx++; const realIndex = r._idx;
    const tr=document.createElement('tr'); tr.dataset.idx = realIndex;
    if(r._isAgg) tr.style.background = "#fff8e1"; 
    const isLong = r.group === 'long'; const grpClass = isLong ? 'grp-long' : 'grp-short'; const grpText = isLong ? 'ì¥' : 'ë‹¨';
    const stepVal = (r.cur >= 100000) ? 500 : 100;
    const dDayStr = getDDay(r.date); const dDayClass = (dDayStr.startsWith('D+0') || dDayStr==='D-Day') ? 'new' : 'old';
    const dDayBadge = dDayStr ? `<span class="d-day-badge ${dDayClass}">${dDayStr}</span>` : '';
    const hasMemo = r.memo && r.memo.trim().length > 0; const memoClass = hasMemo ? 'has-memo' : '';
    const memoTooltip = hasMemo ? `<div class="memo-tooltip">${r.memo}</div>` : '';
    const readOnlyAttr = r._isAgg ? 'readonly style="color:#aaa"' : '';
    const dr = r.dRate || 0; const drClass = dr > 0 ? 'profit-pos' : (dr < 0 ? 'profit-neg' : ''); const drStr = (dr > 0 ? '+' : '') + dr + '%';

    let statusHtml = '';
    const rQty = Number(r.qty) || 0;
    const rFix = Number(r.fix) || 0;
    if (rQty > 0 && rFix > 0) statusHtml = '<span class="status-badge st-sold">ë§¤ë„ë¨</span>';
    else if (rQty > 0 && !rFix) statusHtml = '<span class="status-badge st-active">ìš´ì˜ì¤‘</span>';
    else statusHtml = '<span class="status-badge st-watch">ê´€ë§</span>';

    tr.innerHTML=`
      <td class="row-no ${memoClass}" title="No">
        ${displayIdx}<span class="memo-indicator"></span>${memoTooltip}
      </td>
      <td><button class="grp-btn ${grpClass}" ${r._isAgg ? 'disabled style="opacity:0.5"' : ''}>${grpText}</button></td>
      <td>${statusHtml}</td>
      <td><input class="code" value="${r.code||''}" ${readOnlyAttr}></td>
      <td><input class="name" value="${r.name||''}" ${readOnlyAttr}></td>
      
      <td><div class="date-cell">${dDayBadge}<input type="date" class="date" value="${r.date||''}" ${readOnlyAttr}></div></td>
      <td><input type="date" class="sdate" value="${r.sellDate||''}" ${readOnlyAttr}></td>

      <td><input class="avg" value="${r.avg?fmt(r.avg):''}" ${readOnlyAttr}></td>
      <td><input class="qty" value="${r.qty||''}" ${readOnlyAttr}></td>
      <td><input class="inv" readonly value="${fmt((r.avg||0)*(r.qty||0))}"></td>
      <td><div class="target-cell"><span class="dot ut-dot"></span><input class="utarget" type="number" step="${stepVal}" value="${r.utarget||''}"></div></td>
      <td><div class="target-cell"><span class="dot lt-dot"></span><input class="ltarget" type="number" step="${stepVal}" value="${r.ltarget||''}"></div></td>
      
      <td class="cur-cell">
        <input class="cur" value="${r.cur?fmt(r.cur):''}" style="font-weight:bold;">
        <div class="trend-dots"></div> 
      </td>
      <td><span style="font-size:11px;" class="${drClass}">${drStr}</span></td>

      <td><input class="fix" value="${r.fix?fmt(r.fix):''}" ${readOnlyAttr}></td>
      
      <td><span class="dp">0</span></td>
      <td><span class="pw">0</span></td>
      
      <td><span class="pp">0%</span></td>
      <td>
        <span class="actions">
          <button class="chart-btn">ì°¨íŠ¸</button>
          <span class="mv" style="${r._isAgg ? 'display:none' : ''}">
            <button class="up">â–²</button><button class="dn">â–¼</button>
          </span>
          ${r._isAgg ? '<span style="font-size:11px; color:#aaa;">ë¬¶ìŒ</span>' : '<button class="del">ì‚­ì œ</button>'}
        </span>
      </td>`;
    tb.appendChild(tr);

    if (!r._isAgg) {
        const bindInput = (sel, key, isNum) => {
            const el = tr.querySelector(sel); if(!el) return;
            el.addEventListener('change', ()=>{
                let val = el.value; if(isNum) val = toNum(val); 
                rows[realIndex][key] = val; 
                saveRows();
                
                if (key === 'fix') {
                    if (val > 0 && !rows[realIndex].sellDate) {
                        const today = new Date();
                        rows[realIndex].sellDate = today.getFullYear() + '-' + 
                                                   String(today.getMonth()+1).padStart(2,'0') + '-' + 
                                                   String(today.getDate()).padStart(2,'0');
                    }
                    moveSoldRowToBottom(realIndex);
                } 
                else if (key === 'date') render();
                else updateRowCalculation(tr, rows[realIndex]);
            });
            if(isNum && el.type !== 'number') el.addEventListener('blur', ()=> el.value = rows[realIndex][key] ? fmt(rows[realIndex][key]) : '');
        };
        bindInput('.code', 'code'); bindInput('.name', 'name'); bindInput('.date', 'date'); bindInput('.sdate', 'sellDate');
        bindInput('.avg', 'avg', true); bindInput('.qty', 'qty', true);
        bindInput('.cur', 'cur', true); bindInput('.fix', 'fix', true);
        bindInput('.utarget', 'utarget', true); bindInput('.ltarget', 'ltarget', true);
        tr.querySelector('.del').onclick = () => { if(confirm('ì‚­ì œ?')) { rows.splice(realIndex,1); saveRows(); render(); } };
        const btnUp = tr.querySelector('.up'); if(btnUp) btnUp.onclick = () => { if(realIndex>0) { [rows[realIndex-1], rows[realIndex]] = [rows[realIndex], rows[realIndex-1]]; saveRows(); render(); } };
        const btnDn = tr.querySelector('.dn'); if(btnDn) btnDn.onclick = () => { if(realIndex<rows.length-1) { [rows[realIndex+1], rows[realIndex]] = [rows[realIndex], rows[realIndex+1]]; saveRows(); render(); } };
        // [ì‹ ê·œ] ì‹¤ìˆ˜ë°©ì§€ ê¸°ëŠ¥ ì ìš©
        tr.querySelector('.grp-btn').onclick = () => { 
            if(confirm('ì¥íˆ¬/ë‹¨íƒ€ ê·¸ë£¹ì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                rows[realIndex].group = (rows[realIndex].group === 'short') ? 'long' : 'short'; 
                saveRows(); 
                render(); 
            }
        };
        tr.querySelector('.row-no').addEventListener('click', (e) => {
             if(e.target.classList.contains('memo-tooltip')) return;
             const newMemo = prompt("ğŸ“ ë©”ëª¨:", rows[realIndex].memo || "");
             if(newMemo !== null) { rows[realIndex].memo = newMemo; saveRows(); render(); }
        });
    } else {
        const bindTarget = (sel, key) => {
            const el = tr.querySelector(sel);
            el.addEventListener('change', () => { rows[realIndex][key] = toNum(el.value); saveRows(); updateRowCalculation(tr, r); });
        };
        bindTarget('.utarget', 'utarget'); bindTarget('.ltarget', 'ltarget');
    }
    tr.querySelector('.chart-btn').onclick = () => showChart(r.code, r.name.replace(/\s\(í•©:\d+\)/, ''));
    updateRowCalculation(tr, r);
  });
  updateTotalProfit();
}

function moveSoldRowToBottom(index) {
    const target = rows[index];
    if (target.qty > 0 && target.fix > 0) {
        rows.splice(index, 1);
        let insertAt = rows.length; 
        for(let i=0; i < rows.length; i++){
            if(!rows[i].qty || Number(rows[i].qty) <= 0) {
                insertAt = i;
                break;
            }
        }
        rows.splice(insertAt, 0, target);
        saveRows(); render(); 
    } else { render(); }
}

document.addEventListener('DOMContentLoaded', () => {
    const mergeToggle = $('#mergeToggle'); if(mergeToggle) mergeToggle.addEventListener('change', render);
    const hideWatchToggle = $('#hideWatchToggle'); if(hideWatchToggle) hideWatchToggle.addEventListener('change', render);
});

function updateRowCalculation(tr, r){
  r.inv = (r.avg||0) * (r.qty||0); tr.querySelector('.inv').value = fmt(r.inv);
  const {won, pct} = calcProfit(r.avg, r.cur, r.fix, r.qty);
  
  let dayProfit = 0;
  if (r._isAgg && r.dayProfit !== undefined) {
      dayProfit = r.dayProfit;
  } else {
      dayProfit = calculateDayProfitForRow(r);
  }

  const dp = tr.querySelector('.dp');
  if(dp) {
      dp.textContent = fmt(Math.round(dayProfit));
      dp.className = 'dp ' + (dayProfit >= 0 ? 'profit-pos' : 'profit-neg');
  }

  const pw = tr.querySelector('.pw'); const pp = tr.querySelector('.pp');
  if(pw) { pw.textContent = fmt(Math.round(won)); pw.className = 'pw ' + (won >= 0 ? 'profit-pos' : 'profit-neg'); }
  if(pp) { pp.textContent = pct.toFixed(2) + '%'; pp.className = 'pp ' + (pct >= 0 ? 'profit-pos' : 'profit-neg'); }
  
  if (!r.fix || r.fix == 0) {
      const utDot = tr.querySelector('.ut-dot'); const ltDot = tr.querySelector('.lt-dot');
      if(utDot) utDot.className = 'dot ut-dot' + (r.utarget > 0 && r.cur >= r.utarget ? ' red blink-red-dot' : '');
      if(ltDot) ltDot.className = 'dot lt-dot' + (r.ltarget > 0 && r.cur <= r.ltarget ? ' blue blink-blue-dot' : '');
  }

  const curTd = tr.querySelector('.cur').closest('td');
  if(r.qty > 0 && !r.fix) { curTd.style.backgroundColor = '#e0f7fa'; tr.querySelector('.qty').style.fontWeight = 'bold'; }
  else if(r.fix > 0) { curTd.style.backgroundColor = ''; tr.querySelector('.fix').closest('td').style.backgroundColor = '#eee'; }
  else { curTd.style.backgroundColor = ''; }
  updateHistoryVisuals(tr, r.code, r.cur);
}

function updateTotalProfit(){
  let totalProfit = 0; let operatingProfit = 0; 
  let operatingInvest = 0; let operatingAsset = 0; // [ì‹ ê·œ] ìì‚°í˜„í™© ë³€ìˆ˜

  rows.forEach(r => {
    if(currentFilter === 'short' && r.group === 'long') return;
    if(currentFilter === 'long' && r.group === 'short') return;
    const {won} = calcProfit(r.avg, r.cur, r.fix, r.qty);
    totalProfit += won; 
    
    // ìš´ì˜ì¤‘ì¸ ì¢…ëª© (ìˆ˜ëŸ‰ ìˆê³  ë§¤ë„ê°€ ì—†ìŒ)
    if(r.qty > 0 && !r.fix) { 
        operatingProfit += won; 
        operatingInvest += (r.avg || 0) * r.qty; // íˆ¬ì…ê¸ˆ
        operatingAsset += (r.cur || 0) * r.qty;  // ìì‚°(í‰ê°€ì•¡)
    }
  });

  const elTotal = $('#totalProfit');
  if(elTotal) { elTotal.textContent = fmt(Math.round(totalProfit)); elTotal.className = totalProfit >= 0 ? 'profit-pos' : 'profit-neg'; }
  const elOperating = $('#operatingProfit');
  if(elOperating) { elOperating.textContent = fmt(Math.round(operatingProfit)); elOperating.className = operatingProfit >= 0 ? 'profit-pos' : 'profit-neg'; }
  
  const topEl = $('#topTotal');
  if(topEl) {
    const opColor = operatingProfit >= 0 ? '#d32f2f' : '#1976d2'; 
    // [ì‹ ê·œ] íˆ¬ì…ê¸ˆ, ìì‚° í˜„í™© ì¶”ê°€
    topEl.innerHTML = `
        ì´: ${fmt(Math.round(totalProfit))} 
        <span style="font-size:0.9em; margin-left:4px; color:${opColor}; font-weight:normal;">(ìš´ì˜: ${fmt(Math.round(operatingProfit))})</span>
        <span style="margin-left:8px; font-size:0.9em; color:#555;"> | íˆ¬ì…: ${fmt(Math.round(operatingInvest))} | ìì‚°: ${fmt(Math.round(operatingAsset))}</span>
    `;
    topEl.className = 'top-total ' + (totalProfit >= 0 ? 'total-pos' : 'total-neg');
  }
}

async function fetchPrices(){
  if(!rows.length) return;
  const targetRows = rows.filter(r => (!r.fix || r.fix == 0) || (r.group === 'short' && r.fix > 0));
  const codes = targetRows.map(r => r.code).filter(c => c && c.length >= 6);
  if(!codes.length) { rows.forEach(r => { if(r.fix > 0 && r.group === 'long') { r.cur = 0; r.dRate = 0; } }); setStatus('í™œì„± ì¢…ëª© ì—†ìŒ', true); return; }
  
  const uniqueCodes = [...new Set(codes)].map(c => { let code = c.trim().toUpperCase(); if(/^\d{6}$/.test(code)) return code; return code.replace('.KS','').replace('.KQ',''); });
  const url = `${settings.apiBase}/api/prices?codes=${uniqueCodes.join(',')}&t=${Date.now()}`;
  setStatus('ê°±ì‹ ì¤‘...', true);
  try {
    const res = await fetch(url, {cache:'no-store'}); if(!res.ok) throw new Error('HTTP '+res.status);
    const json = await res.json(); const data = json.data || [];
    const priceMap = {}; const rateMap = {}; 
    data.forEach(d => {
      const code = d.code || d.cd || d.symbol; const price = d.price || d.nv || d.last; const rate = d.day_rate || d.rate || 0; 
      if(code) { priceMap[code] = Number(price); rateMap[code] = Number(rate); }
    });
    let changed = false;
    rows.forEach(r => {
      if(r.fix > 0 && r.group === 'long') { if(r.cur !== 0) { r.cur = 0; r.dRate = 0; changed = true; } return; }
      
      if(!r.code) return;
      const key = r.code.replace('.KS','').replace('.KQ','');
      if(priceMap[key] !== undefined) {
        if(r.cur !== priceMap[key]) { r.cur = priceMap[key]; addSnapshot(r.code, r.cur); changed = true; }
        if(r.dRate !== rateMap[key]) { r.dRate = rateMap[key]; changed = true; }
      }
    });
    if(changed) { saveRows(); render(); }
    setStatus('OK ' + new Date().toLocaleTimeString(), true);
  } catch(e) { console.error(e); setStatus('ì—ëŸ¬: '+e.message, false); }
}

let timerId = null;
function startPolling(){
  if(timerId) clearInterval(timerId);
  const sec = Math.max(2, Number($('#pollSec').value)||10);
  timerId = setInterval(() => { if($('#liveToggle').checked) fetchPrices(); }, sec * 1000);
  if($('#liveToggle').checked) fetchPrices();
}
function setStatus(msg, isOk){ const el = $('#status'); if(el) { el.textContent = msg; el.style.color = isOk ? 'green' : 'red'; } }

const HIST_KEY_PREFIX = "hist_";
function getHistKey(code) { return HIST_KEY_PREFIX + code; }
function loadHist(code){ try{ return JSON.parse(localStorage.getItem(getHistKey(code)))||[]; }catch{return[];} }
function addSnapshot(code, price){
  const key = getHistKey(code); let hist = loadHist(code); const now = Date.now(); const last = hist[hist.length-1];
  if(!last || (now - last.t > 5*60*1000)) { hist.push({t:now, p:price}); if(hist.length > 200) hist.shift(); localStorage.setItem(key, JSON.stringify(hist)); }
}
function updateHistoryVisuals(tr, code, cur){
  if(!code || !cur) return; const hist = loadHist(code); if(!hist.length) return;
  const dotsBox = tr.querySelector('.trend-dots');
  if(dotsBox && hist.length >= 2) {
    const recent = hist.slice(-6); let dotsHtml = '';
    for(let i=1; i<recent.length; i++){ const prev = recent[i-1].p; const curr = recent[i].p; const cls = curr > prev ? 'up' : (curr < prev ? 'down' : ''); if(cls) dotsHtml += `<span class="trend-dot ${cls}"></span>`; }
    dotsBox.innerHTML = dotsHtml;
  }
}
function showChart(code, name){
  const hist = loadHist(code); if(!hist.length) { alert('íˆìŠ¤í† ë¦¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
  const ctx = $('#histChart').getContext('2d'); if(window.myChart) window.myChart.destroy();
  window.myChart = new Chart(ctx, { type: 'line', data: { labels: hist.map(h => new Date(h.t).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})), datasets: [{ label: name || code, data: hist.map(h => h.p), borderColor: '#ff4d4d', tension: 0.1, pointRadius: 2 }] }, options: { responsive: true, maintainAspectRatio: false } });
  $('#chartTitle').textContent = `${name} (${code})`; $('#chartModal').style.display = 'flex';
}

document.addEventListener('DOMContentLoaded', () => {
  $$('.filter-btn').forEach(btn => { btn.addEventListener('click', () => { $$('.filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); currentFilter = btn.dataset.filter; render(); }); });
  $('#hideSoldToggle').addEventListener('change', render);
  $('#btnSortEmptyQty').addEventListener('click', () => {
    const active = [], sold = [], watch = [];
    rows.forEach(r => { if(r.fix > 0) sold.push(r); else if(r.qty > 0) active.push(r); else watch.push(r); });
    active.sort((a,b) => calcProfit(b.avg, b.cur, b.fix, b.qty).won - calcProfit(a.avg, a.cur, a.fix, a.qty).won);
    watch.sort((a,b) => (a.name||'').localeCompare(b.name||''));
    rows = [...active, ...sold, ...watch]; saveRows(); render();
  });
  $('#btnSetTargets').addEventListener('click', () => {
    let changed = 0;
    rows.forEach(r => {
      if(r.fix > 0) return;
      if(r.qty > 0 && r.avg > 0) { const buyAmt = r.avg * r.qty; const fee = buyAmt * 0.0026; r.utarget = Math.round((buyAmt + fee + 10000) / r.qty); r.ltarget = Math.round((buyAmt + fee - 10000) / r.qty); changed++; } 
      else if(!r.qty && r.cur > 0) { const delta = (r.cur >= 100000) ? 3000 : 300; r.utarget = r.cur + delta; r.ltarget = Math.max(0, r.cur - delta); changed++; }
    });
    if(changed > 0) { saveRows(); render(); alert(`ëª©í‘œê°€ ì„¸íŒ… ì™„ë£Œ (${changed}ê±´)`); } else alert('ëŒ€ìƒ ì—†ìŒ');
  });

  $('#copyTxtBtn').addEventListener('click', () => {
    const headers = ['êµ¬ë¶„', 'ìƒíƒœ', 'ì½”ë“œ', 'ì´ë¦„', 'ë§¤ìˆ˜ì¼', 'ë§¤ë„ì¼', 'ë§¤ìˆ˜ê°€', 'ì£¼ìˆ˜', 'íˆ¬ì…ê¸ˆ', 'ìƒëª©í‘œ', 'í•˜ëª©í‘œ', 'í˜„ì¬ê°€', 'ì¼ì¼%', 'ë§¤ë„ê°€', 'ë‹¹ì¼ì†ìµ', 'ëˆ„ì ì†ìµ', 'ìˆ˜ìµë¥ ', 'ë©”ëª¨'];
    const hideSold = $('#hideSoldToggle').checked;
    const hideWatch = $('#hideWatchToggle').checked; 

    const visibleRows = rows.filter(r => {
        if(currentFilter === 'short' && r.group === 'long') return false;
        if(currentFilter === 'long' && r.group === 'short') return false;
        if(hideSold && r.fix > 0) return false;
        if(hideWatch && (!r.qty || Number(r.qty) <= 0)) return false; 
        return true;
    });
    
    const today = new Date();
    const todayStr = today.getFullYear() + '-' + String(today.getMonth()+1).padStart(2,'0') + '-' + String(today.getDate()).padStart(2,'0');

    const lines = visibleRows.map(r => {
      const {won, pct} = calcProfit(r.avg, r.cur, r.fix, r.qty);
      const drStr = (r.dRate || 0) + '%';
      
      let dayProfit = 0;
      if (r._isAgg && r.dayProfit !== undefined) {
          dayProfit = r.dayProfit;
      } else {
          dayProfit = calculateDayProfitForRow(r);
      }

      let statusStr = 'ê´€ë§';
      if(r.qty>0 && r.fix>0) statusStr='ë§¤ë„ë¨';
      else if(r.qty>0 && !r.fix) statusStr='ìš´ì˜ì¤‘';
      
      return [(r.group === 'long' ? 'ì¥íˆ¬' : 'ë‹¨íƒ€'), statusStr, r.code||'', r.name||'', r.date||'', r.sellDate||'', r.avg||0, r.qty||0, (r.avg||0)*(r.qty||0), r.utarget||0, r.ltarget||0, r.cur||0, drStr, r.fix||0, Math.round(dayProfit), Math.round(won), (pct||0).toFixed(2)+'%', r.memo||''].join('\t');
    });
    navigator.clipboard.writeText(headers.join('\t') + '\n' + lines.join('\n')).then(()=>alert(`ë³µì‚¬ ì™„ë£Œ (${visibleRows.length}ê±´)`));
  });

  const CLOUD_URL = "https://script.google.com/macros/s/AKfycbz9ZQB_vvGIkRVbURaj4g8pdeSf2Dy1GoRvn_1F1T_q8lJqvo6DmXZpt6V9-5XjxuvhUA/exec";
  const CLOUD_ID = "stock-dashboard-rows";
  $('#cloudSaveBtn').addEventListener('click', async () => { if(!confirm('í´ë¼ìš°ë“œì— ì €ì¥?')) return; try { const res = await fetch(CLOUD_URL + "?id=" + CLOUD_ID, { method: "POST", headers: { "Content-Type": "text/plain;charset=UTF-8" }, body: JSON.stringify({ rows, settings, ts: Date.now() }) }); if(res.ok) alert('ì €ì¥ ì„±ê³µ!'); else alert('ì‹¤íŒ¨: ' + res.status); } catch(e) { alert('ì—ëŸ¬: '+e.message); } });
  $('#cloudLoadBtn').addEventListener('click', async () => { if(!confirm('ë¶ˆëŸ¬ì˜¤ë©´ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.')) return; try { const res = await fetch(CLOUD_URL + "?id=" + CLOUD_ID); const json = await res.json(); if(json.rows) { rows = json.rows.map(r => ({ ...r, group: r.group || 'short' })); saveRows(); } if(json.settings) { settings = Object.assign(settings, json.settings); saveSettings(); applySettingsToUI(); } render(); alert('ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ'); } catch(e) { alert('ì—ëŸ¬: '+e.message); } });
  $('#addRowBtn').addEventListener('click', () => { rows.unshift({ group: currentFilter==='long'?'long':'short' }); saveRows(); render(); });
  $('#resetBtn').addEventListener('click', () => { if(confirm('ì´ˆê¸°í™”?')) { rows = []; saveRows(); render(); alert('ì™„ë£Œ'); } });

  loadAll(); render(); startPolling();
});
</script>
</body>
</html>
