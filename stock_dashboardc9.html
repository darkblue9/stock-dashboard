<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Stock Dashboard – qty sort only</title>
<style>
  :root{ --bd:#ddd; --ok:#0a7a0a; --bad:#c00; --fz:14px; }
  html,body{margin:0;font-family:system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Malgun Gothic,sans-serif;font-size:var(--fz)}
  .bar{position:sticky;top:0;z-index:5;display:flex;align-items:center;gap:8px;padding:8px 10px;background:#fff;border-bottom:1px solid var(--bd)}
  .bar input, .bar button{height:28px}
  .bar button{padding:0 10px}
  .state{font-weight:700;margin-left:6px}
  .state.ok{color:var(--ok)} .state.bad{color:var(--bad)}

  table{border-collapse:collapse;width:100%}
  th,td{border:1px solid var(--bd);padding:6px 8px;text-align:center;vertical-align:middle;white-space:nowrap}
  th{background:#fafafa;position:sticky;top:44px;z-index:4}

  col.col-no{width:44px}
  col.col-code{width:90px}
  col.col-name{width:140px}
  col.col-avg{width:110px}
  col.col-qty{width:70px}
  col.col-inv{width:130px}
  col.col-ut{width:110px}
  col.col-lt{width:110px}
  col.col-cur{width:110px}
  col.col-fix{width:110px}
  col.col-profit{width:120px}
  col.col-per{width:90px}
  col.col-act{width:120px}

  td input[type="number"], td input[type="text"]{width:100%;height:28px;box-sizing:border-box}
  td input.readonly{background:#f7f7f7}
  .qty.filled{background:#99ffcc !important}

  .actions{display:inline-flex;gap:6px;align-items:center;justify-content:center}
  .del{height:24px;font-size:12px;padding:0 8px}
</style>
</head>
<body>
  <div class="bar">
    <button id="addBtn">+추가</button>
    <button id="saveBtn">저장</button>
    <button id="copyBtn">텍스트로 복사</button>
    <button id="testBtn">테스트</button>
    <button id="sortQtyBtn">정렬(주수)</button>
    <span id="state" class="state">상태: 대기</span>
  </div>

  <table id="grid">
    <colgroup>
      <col class="col-no"><col class="col-code"><col class="col-name"><col class="col-avg"><col class="col-qty">
      <col class="col-inv"><col class="col-ut"><col class="col-lt">
      <col class="col-cur"><col class="col-fix"><col class="col-profit"><col class="col-per"><col class="col-act">
    </colgroup>
    <thead>
      <tr>
        <th>No</th><th>코드</th><th>이름</th><th>매수가</th><th>주수</th><th>투입금액</th>
        <th>상목표</th><th>하목표</th><th>현재가</th><th>매도가</th><th>손익(원)</th><th>손익(%)</th><th>삭제</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

<script>
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const LS='sd_rows_qtysort_v1';

let rows = loadRows();

function loadRows(){ try{ return JSON.parse(localStorage.getItem(LS)||'[]'); }catch(e){ return []; } }
function saveRows(){ localStorage.setItem(LS, JSON.stringify(rows)); }

function fmt(n){ if(n==null||isNaN(n)) return '0'; const sign=n>=0?'':'-'; const abs=Math.abs(Math.round(n)); return sign+abs.toString().replace(/\B(?=(\d{3})+(?!\d))/g,','); }
function toNum(s){ if(s==null) return 0; return parseFloat(String(s).replace(/[^\d\.-]/g,''))||0; }

function render(){
  const tb=$('#tbody');
  tb.innerHTML='';
  rows.forEach((r,i)=>{
    const tr=document.createElement('tr');
    const avg=toNum(r.avg), qty=toNum(r.qty), cur=toNum(r.cur), fix=(toNum(r.fix)||cur);
    const inv=Math.round(avg*qty);
    const profit=Math.round((fix-avg)*qty);
    const ratio=(avg>0)?((fix-avg)/avg*100):0;
    tr.innerHTML=`
      <td class="row-no">${i+1}</td>
      <td><input class="code" value="${r.code||''}"></td>
      <td><input class="name" value="${r.name||''}"></td>
      <td><input class="avg" type="number" value="${r.avg||''}" step="1"></td>
      <td><input class="qty" type="number" value="${r.qty||''}" step="1"></td>
      <td><input class="readonly inv" value="${fmt(inv)}" readonly></td>
      <td><input class="ut" type="number" value="${r.ut||''}" step="1"></td>
      <td><input class="lt" type="number" value="${r.lt||''}" step="1"></td>
      <td><input class="cur" type="number" value="${r.cur||''}" step="1"></td>
      <td><input class="fix" type="number" value="${r.fix||''}" step="1"></td>
      <td class="profit" style="color:${profit>=0?'#0a7a0a':'#c00'}">${fmt(profit)}</td>
      <td class="per" style="color:${ratio>=0?'#0a7a0a':'#c00'}">${(avg>0?ratio.toFixed(2):'0.00')}%</td>
      <td><span class="actions"><button class="del">삭제</button></span></td>
    `;
    tb.appendChild(tr);

    const get = sel => tr.querySelector(sel);
    function apply(){
      r.code=get('.code').value;
      r.name=get('.name').value;
      r.avg=toNum(get('.avg').value);
      r.qty=toNum(get('.qty').value);
      r.ut =toNum(get('.ut').value);
      r.lt =toNum(get('.lt').value);
      r.cur=toNum(get('.cur').value);
      r.fix=toNum(get('.fix').value);
      calc();
      saveRows();
    }
    function calc(){
      const avg=toNum(r.avg), qty=toNum(r.qty), cur=toNum(r.cur), fix=(toNum(r.fix)||cur);
      const inv=Math.round(avg*qty);
      const profit=Math.round((fix-avg)*qty);
      const ratio=(avg>0)?((fix-avg)/avg*100):0;
      get('.inv').value=fmt(inv);
      tr.querySelector('.profit').style.color = profit>=0?'#0a7a0a':'#c00';
      tr.querySelector('.profit').textContent = fmt(profit);
      tr.querySelector('.per').style.color = ratio>=0?'#0a7a0a':'#c00';
      tr.querySelector('.per').textContent = (avg>0?ratio.toFixed(2):'0.00')+'%';
      // qty highlight
      const q = toNum(get('.qty').value);
      const qel = get('.qty');
      if(q>0){ qel.classList.add('filled'); } else { qel.classList.remove('filled'); }
    }

    // bindings
    ['code','name','avg','qty','ut','lt','cur','fix'].forEach(cls=>{
      get('.'+cls).addEventListener('input', apply);
    });
    get('.del').onclick=()=>{ rows.splice(i,1); saveRows(); render(); };

    // initial calc & paint
    calc();
  });
}

$('#addBtn').onclick=()=>{ rows.push({code:'',name:'',avg:0,qty:0,ut:0,lt:0,cur:0,fix:0}); saveRows(); render(); };
$('#saveBtn').onclick=()=>{ saveRows(); setState('저장됨', true); };
$('#copyBtn').onclick=()=>{
  const header=['No','코드','이름','매수가','주수','투입금액','상목표','하목표','현재가','매도가','손익(원)','손익(%)'].join('\t');
  const lines = rows.map((r,i)=>{
    const avg=toNum(r.avg), qty=toNum(r.qty), cur=toNum(r.cur), fix=(toNum(r.fix)||cur);
    const inv=Math.round(avg*qty), profit=Math.round((fix-avg)*qty);
    const ratio=(avg>0)?(((fix-avg)/avg*100).toFixed(2)+'%'):'0.00%';
    return [i+1, r.code||'', r.name||'', avg, qty, inv, r.ut||'', r.lt||'', cur, r.fix||'', profit, ratio].join('\t');
  });
  const txt = header+'\r\n'+lines.join('\r\n');
  navigator.clipboard.writeText(txt).then(()=>setState('복사 완료', true)).catch(()=>setState('복사 실패', false));
};
$('#testBtn').onclick=()=>{
  if(rows.length===0){
    rows=[
      {code:'005930',name:'삼성전자',avg:98100,qty:10,ut:101000,lt:95000,cur:99600,fix:0},
      {code:'000660',name:'SK하이닉스',avg:593000,qty:0,ut:600000,lt:580000,cur:595000,fix:0},
      {code:'035420',name:'NAVER',avg:190000,qty:0,ut:195000,lt:185000,cur:191000,fix:0},
      {code:'373220',name:'LG에너지솔루션',avg:370000,qty:2,ut:380000,lt:360000,cur:372000,fix:0}
    ];
    saveRows();
  }
  render();
};

function setState(msg, ok){ const s=$('#state'); s.textContent='상태: '+msg; s.classList.toggle('ok', !!ok); s.classList.toggle('bad', ok===false); }

// === 정렬(주수): qty>0 행은 그대로, qty<=0 행만 코드 오름차순으로 아래에 정렬 ===
$('#sortQtyBtn').onclick = () => {
  const withQty = [];
  const noQty   = [];
  rows.forEach(r => (toNum(r.qty)>0 ? withQty : noQty).push(r));
  noQty.sort((a,b)=> String(a.code||'').localeCompare(String(b.code||'')));
  rows = withQty.concat(noQty);
  saveRows();
  render();
};

window.addEventListener('load', render);
</script>
</body>
</html>
