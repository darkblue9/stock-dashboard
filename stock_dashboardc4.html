<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>주식 대시보드 v3.4h (동적 step 100/500 · 텍스트 복사 FIX)</title>
<style>
body{font-family:sans-serif;margin:10px;font-size:12px}
table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:12px}
th,td{border:1px solid #ccc;padding:2px;text-align:center;vertical-align:middle}
input,select,button{font:inherit;font-size:12px}
td input{width:55%;text-align:right}
td input[readonly]{background:#f9f9f9}
.status{font-size:11px}
.profit-pos{color:green}
.profit-neg{color:red}
.actions{display:inline-flex;align-items:center;gap:4px;white-space:nowrap;justify-content:center}
.mv{display:inline-flex;gap:2px}
.mv button,.del{width:18px;height:18px;font-size:10px;padding:0;margin:0}
.del{width:auto;padding:0 6px;height:20px;font-size:11px}
@keyframes pulseRed {0%{box-shadow:0 0 0 0 rgba(255,0,0,.8);}100%{box-shadow:0 0 0 6px rgba(255,0,0,0);}}
@keyframes pulseBlue{0%{box-shadow:0 0 0 0 rgba(0,100,255,.8);}100%{box-shadow:0 0 0 6px rgba(0,100,255,0);}}
.dot{width:8px;height:8px;border-radius:50%;background:#bbb;display:inline-block;flex:0 0 8px}
.dot.red{background:#ff4d4d}
.dot.blue{background:#3d7bff}
.blink-red-dot{animation:pulseRed .9s infinite;}
.blink-blue-dot{animation:pulseBlue .9s infinite;}
.target-cell{display:flex;align-items:center;gap:6px;justify-content:center}
.target-cell input[type="number"]{width:72px}
.toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#333;color:#fff;padding:8px 12px;border-radius:8px;opacity:.95;z-index:9999}

.actions{display:inline-flex;align-items:center;gap:4px;white-space:nowrap;justify-content:center}
.mv{display:inline-flex;gap:2px}
.mv button,.del{width:18px;height:18px;font-size:10px;padding:0;margin:0}
.del{width:auto;padding:0 6px;height:20px;font-size:11px}
.actions .chart{height:20px;padding:0 6px;font-size:11px}

/* width tweaks */
col.col-qty{width:40px}
col.col-profit{width:6.8%}
col.col-percent{width:5.1%}

/* modal & deltas */
.delta-badges{display:inline-flex;gap:4px;margin-left:4px;font-size:10px}
.delta-badge{border:1px solid #ccc;border-radius:8px;padding:0 4px}
.delta-pos{color:green;border-color:green}
.delta-neg{color:#c00;border-color:#c00}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9998}
.modal.show{display:flex}
.modal-card{background:#fff;border-radius:10px;min-width:320px;max-width:90vw;width:720px;max-height:85vh;display:flex;flex-direction:column;box-shadow:0 10px 30px rgba(0,0,0,.3)}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #eee}
.modal-body{padding:10px}
.modal-footer{padding:8px 12px;border-top:1px solid #eee;text-align:right}
.modal-close{padding:4px 10px}
.chart-wrap{width:100%;height:360px}
.chart-wrap canvas{width:100%;height:100%}


/* 상단 총손익 스티키 배지 */
.total-sticky{position:fixed; top:6px; right:12px; background:#fff; border:1px solid #ddd; 
  padding:4px 10px; border-radius:10px; box-shadow:0 4px 14px rgba(0,0,0,.08); 
  font-weight:700; z-index:9999; }
.total-pos{color:#0a7a0a}
.total-neg{color:#c00}

</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js">
/* ===== Price History Snapshot (5-min) + Chart ===== */
const HIST_PREFIX = "hist_v1::"; // per-code key
const slotOf = (t)=> Math.floor(t / (5*60*1000)); // 5-minute slot
function histKey(code){ return HIST_PREFIX + (normalizeCode(code)||''); }
function loadHist(code){ try{ return JSON.parse(localStorage.getItem(histKey(code))||'[]'); }catch{ return []; } }
function saveHist(code, arr){
  const cutoff = Date.now() - 24*60*60*1000;
  const trimmed = arr.filter(x => x && x.t && x.t >= cutoff);
  localStorage.setItem(histKey(code), JSON.stringify(trimmed));
}
function addSnapshotIfNeeded(code, price){
  if(!code || !price) return;
  const now = Date.now();
  const arr = loadHist(code);
  const last = arr[arr.length-1];
  if(last && slotOf(last.t) === slotOf(now)) return;
  arr.push({t: now, p: price});
  if(arr.length > 350) arr.splice(0, arr.length-300);
  saveHist(code, arr);
}
function findPriceAtOrBefore(code, msAgo){
  const target = Date.now() - msAgo;
  const arr = loadHist(code);
  for(let i=arr.length-1;i>=0;i--){ if(arr[i].t <= target) return arr[i].p; }
  return null;
}
function formatDelta(n){ if(n===null || n===undefined) return ''; const s=(n>0?'+':'')+(Math.round(n)); return s; }
function updateDeltaBadges(tr, code, cur){
  if(!tr) return;
  let wrap = tr.querySelector('.cur-deltas');
  if(!wrap){
    wrap = document.createElement('span');
    wrap.className = 'delta-badges cur-deltas';
    const curCell = tr.querySelector('.cur')?.parentElement || tr.children[7];
    curCell && curCell.appendChild(wrap);
  }
  wrap.innerHTML = '';
  const p5  = findPriceAtOrBefore(code, 5*60*1000);
  const p60 = findPriceAtOrBefore(code, 60*60*1000);
  const d5  = (p5  != null && cur)? (cur - p5)  : null;
  const d60 = (p60 != null && cur)? (cur - p60) : null;
  const mk = (val,label)=>{
    if(val==null) return null;
    const el = document.createElement('span');
    el.className = 'delta-badge ' + (val>=0?'delta-pos':'delta-neg');
    el.textContent = label+':'+formatDelta(val);
    return el;
  };
  const a = mk(d5,'Δ5m'); const b = mk(d60,'Δ1h');
  if(a) wrap.appendChild(a); if(b) wrap.appendChild(b);
}
const __orig_updateProfits = updateProfits;
updateProfits = function(){
  __orig_updateProfits();
  try{
    $$('#tbody tr').forEach((tr,i)=>{
      const r = rows[i]||{};
      if(r && r.code && r.cur){
        if($('#trackToggle')?.checked){ addSnapshotIfNeeded(r.code, r.cur); }
        updateDeltaBadges(tr, r.code, r.cur);
      }
    });
  }catch(e){ console.warn('hist update err', e); }
};
setInterval(()=>{
  if(!$('#trackToggle')?.checked) return;
  const nowSlot = slotOf(Date.now());
  $$('#tbody tr').forEach((tr,i)=>{
    const r = rows[i]||{};
    if(r && r.code && r.cur){
      const arr = loadHist(r.code);
      const last = arr[arr.length-1];
      if(!last || slotOf(last.t)!==nowSlot){
        addSnapshotIfNeeded(r.code, r.cur);
        updateDeltaBadges(tr, r.code, r.cur);
      }
    }
  });
}, 30*1000);
let chartInst=null;
function showChart(code,name){
  const modal=$('#chartModal'); if(!modal) return;
  $('#chartTitle').textContent=(name||'')+' ('+(code||'')+')';
  const ctx=$('#histChart').getContext('2d');
  const data=loadHist(code);
  if(!data || !data.length){ alert('저장된 히스토리가 아직 없습니다. 5분 간격 스냅샷이 쌓이면 표시됩니다.'); return; }
  const labels=data.map(d=>{const dt=new Date(d.t);const hh=String(dt.getHours()).padStart(2,'0');const mm=String(dt.getMinutes()).padStart(2,'0');return hh+':'+mm;});
  const prices=data.map(d=>d.p);
  if(chartInst){ chartInst.destroy(); chartInst=null; }
  chartInst=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'가격',data:prices,fill:false,tension:0.2}]},options:{animation:false,plugins:{legend:{display:false}},scales:{x:{ticks:{maxRotation:0,autoSkip:true},grid:{display:false}},y:{beginAtZero:false,grid:{color:'rgba(0,0,0,.08)'}}}}});
  modal.classList.add('show');
}
function hideChart(){ $('#chartModal')?.classList.remove('show'); }
const __orig_render = render;
render = function(){

// ensure chart buttons exist even if template lacked them
(function ensureChartButtons(){
  const trs = $$('#tbody tr');
  trs.forEach((tr)=>{
    const act = tr.querySelector('.actions');
    if(act && !act.querySelector('.chart')){
      const btn = document.createElement('button');
      btn.className='chart';
      btn.textContent='차트';
      act.insertBefore(btn, act.firstChild);
    }
  });
})();

  __orig_render();
  $$('#tbody tr').forEach((tr,i)=>{
    const btn = tr.querySelector('button.chart');
    if(btn){ btn.onclick=()=>{ const r=rows[i]||{}; showChart(r.code,r.name); }; }
  });
  $$('#tbody tr').forEach((tr,i)=>{ const r=rows[i]||{}; if(r && r.code && r.cur){ updateDeltaBadges(tr,r.code,r.cur); } });
};
document.addEventListener('click',(e)=>{ if(e.target.id==='chartClose') hideChart(); if(e.target.id==='chartModal' && e.target.classList.contains('modal')) hideChart(); });


// Event delegation for chart buttons
(function(){
  const tb = document.getElementById('tbody');
  if(!tb) return;
  tb.addEventListener('click', (e)=>{
    const chartBtn = e.target.closest('button.chart');
    if(!chartBtn) return;
    const tr = e.target.closest('tr');
    const idx = Array.from(tb.querySelectorAll('tr')).indexOf(tr);
    if(idx<0) return;
    const r = rows[idx] || {};
    showChart(r.code, r.name);
  });
})();


// ===== 상단 총손익 배지 업데이트 =====
function updateTopTotal(){
  try{
    const els = Array.from(document.body.querySelectorAll('*'));
    let target = null;
    for(const el of els){ 
      const t = (el.textContent||'').trim();
      if(t.startsWith('총 손익:')) target = el; // 마지막 매치로 덮음
    }
    const badge = document.getElementById('totalSticky');
    if(!badge) return;
    if(target){
      const text = target.textContent.trim();
      badge.textContent = text;
      // 색상
      const m = text.match(/총 손익:\s*([\-0-9,]+)/);
      if(m){
        const val = parseFloat(m[1].replace(/,/g,''));
        badge.classList.remove('total-pos','total-neg');
        badge.classList.add(val>=0 ? 'total-pos':'total-neg');
      }
    }
  }catch(e){/* no-op */}
}
// 원래 updateProfits 이후에 상단 배지도 동기화
const __orig_updateProfits2 = updateProfits;
updateProfits = function(){
  __orig_updateProfits2();
  updateTopTotal();
};
// 최초 1회 시도
document.addEventListener('DOMContentLoaded', updateTopTotal);

</script>
</head>
<body>
<div id="totalSticky" class="total-sticky">총 손익: 0</div>

<div>
  <label>프록시 <input id="apiBase" value="http://localhost:3000" style="width:140px"></label>
  <label>엔드포인트 
    <select id="apiMode">
      <option value="auto" selected>자동</option>
      <option value="multi">멀티</option>
      <option value="single">단건</option>
    </select>
  </label>
  <label>코드파라미터 <input id="codeParam" value="code" style="width:70px"></label>
  <label>가격키(JSON) <input id="priceKey" value="price" style="width:90px"></label>
  <label>풀링(초) <input id="pollSec" type="number" value="10" min="2" style="width:48px"></label>
  <label><input type="checkbox" id="liveToggle" checked>실시간</label>
  <button id="addRowBtn">+추가</button>
  <button id="saveBtn">저장</button>
  <button id="testBtn">테스트</button>
  <label><input type="checkbox" id="trackToggle" checked> 변동추적</label>
  <button id="cloudSaveBtn">클라우드 저장</button>
  <button id="cloudLoadBtn">클라우드 불러오기</button>
  <button id="copyTxtBtn">텍스트로 복사</button>
  <span id="status" class="status">상태: 대기</span>
</div>

<table id="grid">
  <colgroup>
    <col class="col-code">
    <col class="col-name">
    <col class="col-avg">
    <col class="col-qty">
    <col class="col-inv">
    <col class="col-utarget">
    <col class="col-ltarget">
    <col class="col-cur">
    <col class="col-fix">
    <col class="col-profit">
    <col class="col-percent">
    <col class="col-act">
  </colgroup>
  <thead><tr>
    <th>코드</th><th>이름</th><th>매수가</th><th>주수</th><th>투입금액</th>
    <th>상목표</th><th>하목표</th><th>현재가</th><th>매도가</th><th>손익(원)</th><th>손익(%)</th><th>▲▼/삭제</th>
  </tr></thead>
  <tbody id="tbody"></tbody>
</table>
<div>총 손익: <span id="totalProfit" class="profit-neg">0</span> (수수료 0.26%)</div>

<script>
const $=(s,el=document)=>el.querySelector(s);
const $$=(s,el=document)=>Array.from(el.querySelectorAll(s));
const fmt=(n)=>(n??0).toLocaleString('ko-KR');
const toNum=(v)=>{ if(v===''||v==null) return 0; if(typeof v==='number') return v; return Number(String(v).replace(/,/g,''))||0; };
const getByPath=(obj,path)=>{ if(!path) return undefined; const parts=String(path).split('.'); let cur=obj; for(const p of parts){ if(cur==null) return undefined; cur=cur[p]; } return cur; };

const FEE_BUY=0.00015, FEE_SELL=0.00015, TAX_SELL=0.00230;
function calcProfit(avg,cur,fix,qty){
  const base=(fix && !isNaN(fix) && fix!==0) ? fix : cur;
  if(!avg||!qty||!base) return {won:0,pct:0};
  const buyAmt=avg*qty, sellAmt=base*qty;
  const feeBuy=buyAmt*FEE_BUY, feeSell=sellAmt*(FEE_SELL+TAX_SELL);
  const profit=(sellAmt-buyAmt)-feeBuy-feeSell;
  return {won:profit, pct: profit/buyAmt*100};
}

const KEY_ROWS='rows_v34h_targetdot';
const KEY_SET ='set_v34h_targetdot';
let rows=[], settings={};

function loadJSON(k,d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d; }catch{ return d; } }
function saveJSON(k,o){ localStorage.setItem(k, JSON.stringify(o)); }
function loadAll(){
  rows=loadJSON(KEY_ROWS,[]);
  settings=Object.assign({
    apiBase:'http://localhost:3000', apiMode:'auto', codeParam:'code', priceKey:'price',
    multiTpl:'/api/prices?codes={codes}', singleTpl:'/api/price?{codeParam}={code}', pollSec:10
  }, loadJSON(KEY_SET,{}));
}
function saveSettings(){
  settings.apiBase=$('#apiBase').value.trim();
  settings.apiMode=$('#apiMode').value;
  settings.codeParam=$('#codeParam').value.trim();
  settings.priceKey=$('#priceKey').value.trim();
  settings.multiTpl=$('#multiTpl')?$('#multiTpl').value.trim():'/api/prices?codes={codes}';
  settings.singleTpl=$('#singleTpl')?$('#singleTpl').value.trim():'/api/price?{codeParam}={code}';
  settings.pollSec=Math.max(2, Number($('#pollSec').value)||10);
  saveJSON(KEY_SET,settings);
}
function saveRows(){ saveJSON(KEY_ROWS,rows); }

function normalizeCode(code){
  let c=(code||'').trim().toUpperCase();
  if(!c) return c;
  if(/^\d{6}$/.test(c)) c+='.KS';
  return c;
}

/* step 동적 조절 */
function adjustStepForRow(tr){
  const curVal=toNum(tr.querySelector('.cur')?.value);
  const step=curVal>=100000?500:100;
  tr.querySelectorAll('.utarget,.ltarget').forEach(inp=>{ if(inp) inp.step=step; });
}
function adjustAllSteps(){ $$('#tbody tr').forEach(adjustStepForRow); }

function render(){
  const tb=$('#tbody'); tb.innerHTML='';
  rows.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input class="code" value="${r.code||''}"></td>
      <td><input class="name" value="${r.name||''}"></td>
      <td><input class="avg" value="${r.avg?fmt(r.avg):''}"></td>
      <td><input class="qty" value="${r.qty||''}"></td>
      <td><input class="inv" readonly></td>
      <td><div class="target-cell"><span class="dot ut-dot"></span>
        <input type="number" min="0" step="100" class="utarget" value="${r.utarget||''}" title="상한목표가">
      </div></td>
      <td><div class="target-cell"><span class="dot lt-dot"></span>
        <input type="number" min="0" step="100" class="ltarget" value="${r.ltarget||''}" title="하한목표가">
      </div></td>
      <td><input class="cur" value="${r.cur?fmt(r.cur):''}"></td>
      <td><input class="fix" value="${r.fix?fmt(r.fix):''}" title="매도가"></td>
      <td><span class="pw">0</span></td>
      <td><span class="pp">0%</span></td>
      <td><span class="actions"><button class="chart">차트</button> <span class="mv"><button class="up">▲</button><button class="down">▼</button></span><button class="del">삭제</button></span></td>`;
    tb.appendChild(tr);

    const upd=()=>applyRow(i,tr);
    $$('.code,.name,.avg,.qty,.cur,.fix,.utarget,.ltarget',tr).forEach(inp=>{
      inp.addEventListener('input',upd);
      inp.addEventListener('blur',upd);
      inp.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); inp.blur(); } });
    });
    tr.querySelector('.del').onclick=()=>{ rows.splice(i,1); saveRows(); render(); };
    const upBtn = tr.querySelector('.up');
    const downBtn = tr.querySelector('.down');
    if(upBtn){ upBtn.onclick=()=>{ if(i>0){ [rows[i-1],rows[i]]=[rows[i],rows[i-1]]; saveRows(); render(); } }; }
    if(downBtn){ downBtn.onclick=()=>{ if(i<rows.length-1){ [rows[i+1],rows[i]]=[rows[i],rows[i+1]]; saveRows(); render(); } }; }

    adjustStepForRow(tr);
  });
  updateProfits();
}

function applyRow(i,tr,live){
  const r=rows[i]||(rows[i]={});
  const get=(sel)=> (tr.querySelector(sel)?.value || '').trim();
  r.code=get('.code'); r.name=get('.name');
  r.avg=toNum(get('.avg')); r.qty=toNum(get('.qty'));
  r.cur=toNum(get('.cur')); r.fix=toNum(get('.fix'));
  r.utarget=toNum(get('.utarget')); r.ltarget=toNum(get('.ltarget'));
  r.inv=(r.avg||0)*(r.qty||0);
  tr.querySelector('.inv').value=fmt(r.inv||0);
  if(!live){
    tr.querySelector('.avg').value=r.avg?fmt(r.avg):'';
    tr.querySelector('.cur').value=r.cur?fmt(r.cur):'';
    tr.querySelector('.fix').value=r.fix?fmt(r.fix):'';
  }
  adjustStepForRow(tr);
  saveRows();
  updateProfits();
}

function updateProfits(){
  let total=0;
  $$('#tbody tr').forEach((tr,i)=>{
    const r=rows[i]||{};
    r.inv=(r.avg||0)*(r.qty||0);
    tr.querySelector('.inv').value=fmt(r.inv);
    const {won,pct}=calcProfit(r.avg,r.cur,r.fix,r.qty);
    total+=won;
    const pw=tr.querySelector('.pw'), pp=tr.querySelector('.pp');
    if(pw){ pw.textContent=fmt(Math.round(won)); pw.className='pw '+(won>=0?'profit-pos':'profit-neg'); }
    if(pp){ pp.textContent=(isFinite(pct)?pct.toFixed(2):'0.00')+'%'; }
    const utDot=tr.querySelector('.ut-dot'), ltDot=tr.querySelector('.lt-dot');
    const up=(r.utarget||0)>0 && (r.cur||0)>=r.utarget;
    const dn=(r.ltarget||0)>0 && (r.cur||0)<=r.ltarget;
    utDot.className='dot ut-dot'+(up?' red blink-red-dot':'');
    ltDot.className='dot lt-dot'+(dn?' blue blink-blue-dot':'');
  });
  const t=$('#totalProfit'); if(t){ t.textContent=fmt(Math.round(total)); t.className=(total>=0?'profit-pos':'profit-neg'); }
  saveRows();
}

function buildUrlSingle(code){
  const base=($('#apiBase').value||'').trim().replace(/\/$/,'');
  const tpl=('/api/price?{codeParam}={code}');
  const codeParam=($('#codeParam').value||'code').trim();
  const path=tpl.replace('{code}', encodeURIComponent(code)).replace('{codeParam}', encodeURIComponent(codeParam));
  return base+path;
}
function buildUrlMulti(codes){
  const base=($('#apiBase').value||'').trim().replace(/\/$/,'');
  const tpl=('/api/prices?codes={codes}');
  const path=tpl.replace('{codes}', encodeURIComponent(codes.join(',')));
  return base+path;
}

async function fetchPricesAuto(codes){
  const mode=$('#apiMode').value;
  try{
    if(mode==='multi'){ await fetchPricesMulti(codes); }
    else if(mode==='single'){ await fetchPricesSingle(codes); }
    else{ await fetchPricesMulti(codes).catch(()=>fetchPricesSingle(codes)); }
    setStatus('OK', true);
  }catch(err){
    console.warn(err);
    setStatus(err.message||'오류', false);
  }
}
async function fetchPricesMulti(codes){
  saveSettings();
  const url=buildUrlMulti(codes.map(normalizeCode));
  const res=await fetch(url,{cache:'no-store'});
  if(!res.ok) throw new Error('HTTP '+res.status);
  const j=await res.json();
  const priceKey=($('#priceKey').value||'price').trim();
  const codeParam=($('#codeParam').value||'code').trim();
  const arr=Array.isArray(j)?j:(j.data||j.results||[]);
  arr.forEach(p=>{
    const code=String(p[codeParam]||p.code||p.symbol||p.ticker||'').toUpperCase();
    const price=Number(getByPath(p,priceKey))||Number(p.price)||Number(p.last)||0;
    rows.forEach(row=>{ if(normalizeCode(row.code)===code){ row.cur=price||row.cur||0; } });
  });
  saveRows();
  $$('#tbody tr').forEach((tr,i)=>{
    const inp=tr.querySelector('.cur');
    if(inp) inp.value = rows[i].cur?fmt(rows[i].cur):'';
    adjustStepForRow(tr);
  });
  updateProfits();
}
async function fetchPricesSingle(codes){
  saveSettings();
  const priceKey=($('#priceKey').value||'price').trim();
  const results=await Promise.allSettled(codes.map(async code=>{
    const url=buildUrlSingle(normalizeCode(code));
    const res=await fetch(url,{cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const j=await res.json();
    const price=Number(getByPath(j,priceKey))||Number(j.price)||Number(j.last)||Number(j?.data?.price)||0;
    return {code:normalizeCode(code), price};
  }));
  results.forEach(r=>{
    if(r.status==='fulfilled'){
      const {code,price}=r.value;
      rows.forEach(row=>{ if(normalizeCode(row.code)===code){ row.cur=price||row.cur||0; } });
    }
  });
  saveRows();
  $$('#tbody tr').forEach((tr,i)=>{
    const inp=tr.querySelector('.cur');
    if(inp) inp.value = rows[i].cur?fmt(rows[i].cur):'';
    adjustStepForRow(tr);
  });
  updateProfits();
}

let timerId=null;
function tick(){
  if(!$('#liveToggle').checked) return;
  const codes=rows.map(r=>r.code).filter(Boolean);
  if(!codes.length) return;
  fetchPricesAuto(codes);
}
function startPolling(){
  stopPolling();
  if(!$('#liveToggle').checked) return;
  const sec=Math.max(2, Number($('#pollSec').value)||10);
  timerId=setInterval(tick, sec*1000);
  tick();
}
function stopPolling(){ if(timerId){ clearInterval(timerId); timerId=null; } }

function setStatus(text, ok){
  const s=$('#status');
  if(s){ s.textContent='상태: '+text; s.style.color=ok?'green':'red'; }
}

/* 텍스트로 복사 */
function showToast(msg){
  const t=document.createElement('div'); t.className='toast'; t.textContent=msg;
  document.body.appendChild(t); setTimeout(()=>t.remove(),1600);
}
function exportToText(){
  const headers=['코드','이름','매수가','주수','투입금액','상목표','하목표','현재가','매도가','손익(원)','손익(%)'];
  const lines=[headers.join('\t')];
  rows.forEach(r=>{
    const {code='',name='',avg=0,qty=0,inv=0,utarget=0,ltarget=0,cur=0,fix=0}=r||{};
    const {won,pct}=calcProfit(avg,cur,fix,qty);
    lines.push([
      code,
      name,
      fmt(avg),
      qty,
      fmt(inv),
      utarget?fmt(utarget):'',
      ltarget?fmt(ltarget):'',
      cur?fmt(cur):'',
      fix?fmt(fix):'',
      fmt(Math.round(won)),
      (isFinite(pct)?pct.toFixed(2):'0.00')+'%'
    ].join('\t'));
  });
  const out = lines.join('\r\n');
  if(navigator.clipboard){
    navigator.clipboard.writeText(out).then(()=>showToast('복사 완료! 엑셀에 붙여넣기(Ctrl+V) 하세요.'),()=>fallbackCopy(out));
  }else{ fallbackCopy(out); }
}
function fallbackCopy(text){
  const ta=document.createElement('textarea');
  ta.value=text; ta.style.position='fixed'; ta.style.left='-9999px';
  document.body.appendChild(ta); ta.focus(); ta.select();
  try{ document.execCommand('copy'); showToast('복사 완료! 엑셀에 붙여넣기(Ctrl+V) 하세요.'); }
  catch{ alert('복사 실패. 아래 텍스트를 수동 복사하세요:\n\n'+text); }
  finally{ ta.remove(); }
}

/* 초기 */
function ensureTopbar(){
  if(!document.getElementById('status')){
    const d=document.createElement('div');
    d.innerHTML='<span id="status" class="status">상태: 대기</span>';
    document.body.insertBefore(d, document.body.firstChild);
  }
}
function initRowsIfEmpty(){
  if(!rows.length){
    rows=[
      {code:'009830',name:'한화솔루션',avg:33800,qty:80,cur:30800,utarget:31400,ltarget:30000},
      {code:'000250',name:'삼천당제약',avg:241000,qty:5,cur:234000,utarget:234000,ltarget:220000},
      {code:'100090',name:'SK오션플랜트',avg:21950,qty:115,cur:20650,utarget:20550,ltarget:19800},
      {code:'000660.KS',name:'SK하이닉스',avg:586000,qty:4,cur:581000,utarget:551000,ltarget:530000}
    ];
    saveRows();
  }
}
function bindTopbar(){
  const ids=['apiBase','apiMode','codeParam','priceKey','multiTpl','singleTpl','pollSec'];
  ids.forEach(id=>{ const el=document.getElementById(id); if(el){ el.addEventListener('change', saveSettings); } });
  const lt=document.getElementById('liveToggle'); if(lt){ lt.onchange=()=>{ if(lt.checked) startPolling(); else stopPolling(); }; }
  const add=document.getElementById('addRowBtn'); if(add){ add.onclick=()=>{ rows.push({}); saveRows(); render(); }; }
  const save=document.getElementById('saveBtn'); if(save){ save.onclick=()=>{ saveSettings(); saveRows(); alert('저장되었습니다.'); }; }
  const test=document.getElementById('testBtn'); if(test){ test.onclick=()=>{ const c=rows.map(r=>r.code).filter(Boolean); if(!c.length){alert('코드를 먼저 입력하세요');return;} fetchPricesAuto([c[0]]); }; }
  const copy=document.getElementById('copyTxtBtn'); if(copy){ copy.onclick=exportToText; }
}

function loadAllAndStart(){
  try{ const s=JSON.parse(localStorage.getItem(KEY_SET)||'null'); if(s) settings=s; }catch{}
  settings=Object.assign({
    apiBase:'http://localhost:3000', apiMode:'auto', codeParam:'code', priceKey:'price',
    multiTpl:'/api/prices?codes={codes}', singleTpl:'/api/price?{codeParam}={code}', pollSec:10
  }, settings||{});
  [['apiBase','apiBase'],['apiMode','apiMode'],['codeParam','codeParam'],['priceKey','priceKey'],
   ['multiTpl','multiTpl'],['singleTpl','singleTpl'],['pollSec','pollSec']].forEach(([id,key])=>{
    const el=document.getElementById(id); if(el){ el.value=settings[key]; }
  });
}

loadAll();
loadAllAndStart();
bindTopbar();
ensureTopbar();
initRowsIfEmpty();
render();
startPolling();

/* ===== Price History Snapshot (5-min) + Chart ===== */
const HIST_PREFIX = "hist_v1::"; // per-code key
const slotOf = (t)=> Math.floor(t / (5*60*1000)); // 5-minute slot
function histKey(code){ return HIST_PREFIX + (normalizeCode(code)||''); }
function loadHist(code){ try{ return JSON.parse(localStorage.getItem(histKey(code))||'[]'); }catch{ return []; } }
function saveHist(code, arr){
  const cutoff = Date.now() - 24*60*60*1000;
  const trimmed = arr.filter(x => x && x.t && x.t >= cutoff);
  localStorage.setItem(histKey(code), JSON.stringify(trimmed));
}
function addSnapshotIfNeeded(code, price){
  if(!code || !price) return;
  const now = Date.now();
  const arr = loadHist(code);
  const last = arr[arr.length-1];
  if(last && slotOf(last.t) === slotOf(now)) return;
  arr.push({t: now, p: price});
  if(arr.length > 350) arr.splice(0, arr.length-300);
  saveHist(code, arr);
}
function findPriceAtOrBefore(code, msAgo){
  const target = Date.now() - msAgo;
  const arr = loadHist(code);
  for(let i=arr.length-1;i>=0;i--){ if(arr[i].t <= target) return arr[i].p; }
  return null;
}
function formatDelta(n){ if(n===null || n===undefined) return ''; const s=(n>0?'+':'')+(Math.round(n)); return s; }
function updateDeltaBadges(tr, code, cur){
  if(!tr) return;
  let wrap = tr.querySelector('.cur-deltas');
  if(!wrap){
    wrap = document.createElement('span');
    wrap.className = 'delta-badges cur-deltas';
    const curCell = tr.querySelector('.cur')?.parentElement || tr.children[7];
    curCell && curCell.appendChild(wrap);
  }
  wrap.innerHTML = '';
  const p5  = findPriceAtOrBefore(code, 5*60*1000);
  const p60 = findPriceAtOrBefore(code, 60*60*1000);
  const d5  = (p5  != null && cur)? (cur - p5)  : null;
  const d60 = (p60 != null && cur)? (cur - p60) : null;
  const mk = (val,label)=>{
    if(val==null) return null;
    const el = document.createElement('span');
    el.className = 'delta-badge ' + (val>=0?'delta-pos':'delta-neg');
    el.textContent = label+':'+formatDelta(val);
    return el;
  };
  const a = mk(d5,'Δ5m'); const b = mk(d60,'Δ1h');
  if(a) wrap.appendChild(a); if(b) wrap.appendChild(b);
}
const __orig_updateProfits = updateProfits;
updateProfits = function(){
  __orig_updateProfits();
  try{
    $$('#tbody tr').forEach((tr,i)=>{
      const r = rows[i]||{};
      if(r && r.code && r.cur){
        if($('#trackToggle')?.checked){ addSnapshotIfNeeded(r.code, r.cur); }
        updateDeltaBadges(tr, r.code, r.cur);
      }
    });
  }catch(e){ console.warn('hist update err', e); }
};
setInterval(()=>{
  if(!$('#trackToggle')?.checked) return;
  const nowSlot = slotOf(Date.now());
  $$('#tbody tr').forEach((tr,i)=>{
    const r = rows[i]||{};
    if(r && r.code && r.cur){
      const arr = loadHist(r.code);
      const last = arr[arr.length-1];
      if(!last || slotOf(last.t)!==nowSlot){
        addSnapshotIfNeeded(r.code, r.cur);
        updateDeltaBadges(tr, r.code, r.cur);
      }
    }
  });
}, 30*1000);
let chartInst=null;
function showChart(code,name){
  const modal=$('#chartModal'); if(!modal) return;
  $('#chartTitle').textContent=(name||'')+' ('+(code||'')+')';
  const ctx=$('#histChart').getContext('2d');
  const data=loadHist(code);
  if(!data || !data.length){ alert('저장된 히스토리가 아직 없습니다. 5분 간격 스냅샷이 쌓이면 표시됩니다.'); return; }
  const labels=data.map(d=>{const dt=new Date(d.t);const hh=String(dt.getHours()).padStart(2,'0');const mm=String(dt.getMinutes()).padStart(2,'0');return hh+':'+mm;});
  const prices=data.map(d=>d.p);
  if(chartInst){ chartInst.destroy(); chartInst=null; }
  chartInst=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'가격',data:prices,fill:false,tension:0.2}]},options:{animation:false,plugins:{legend:{display:false}},scales:{x:{ticks:{maxRotation:0,autoSkip:true},grid:{display:false}},y:{beginAtZero:false,grid:{color:'rgba(0,0,0,.08)'}}}}});
  modal.classList.add('show');
}
function hideChart(){ $('#chartModal')?.classList.remove('show'); }
const __orig_render = render;
render = function(){

// ensure chart buttons exist even if template lacked them
(function ensureChartButtons(){
  const trs = $$('#tbody tr');
  trs.forEach((tr)=>{
    const act = tr.querySelector('.actions');
    if(act && !act.querySelector('.chart')){
      const btn = document.createElement('button');
      btn.className='chart';
      btn.textContent='차트';
      act.insertBefore(btn, act.firstChild);
    }
  });
})();

  __orig_render();
  $$('#tbody tr').forEach((tr,i)=>{
    const btn = tr.querySelector('button.chart');
    if(btn){ btn.onclick=()=>{ const r=rows[i]||{}; showChart(r.code,r.name); }; }
  });
  $$('#tbody tr').forEach((tr,i)=>{ const r=rows[i]||{}; if(r && r.code && r.cur){ updateDeltaBadges(tr,r.code,r.cur); } });
};
document.addEventListener('click',(e)=>{ if(e.target.id==='chartClose') hideChart(); if(e.target.id==='chartModal' && e.target.classList.contains('modal')) hideChart(); });


// Event delegation for chart buttons
(function(){
  const tb = document.getElementById('tbody');
  if(!tb) return;
  tb.addEventListener('click', (e)=>{
    const chartBtn = e.target.closest('button.chart');
    if(!chartBtn) return;
    const tr = e.target.closest('tr');
    const idx = Array.from(tb.querySelectorAll('tr')).indexOf(tr);
    if(idx<0) return;
    const r = rows[idx] || {};
    showChart(r.code, r.name);
  });
})();

</script>

<div id="chartModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-header">
      <strong id="chartTitle">차트</strong>
      <button id="chartClose" class="modal-close">닫기</button>
    </div>
    <div class="modal-body">
      <div class="chart-wrap"><canvas id="histChart"></canvas></div>
    </div>
    <div class="modal-footer">
      <small>최근 24시간, 5분 간격 스냅샷</small>
    </div>
  </div>
</div>

</body>
</html>
