<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ë§ˆë…€ì˜ ì£¼ì‹ ëŒ€ì‹œë³´ë“œ v5.3 (ì‹œì›ì‹œì› í°ê¸€ì”¨)</title>
<style>
/* === ê¸°ë³¸ ìŠ¤íƒ€ì¼ (í°íŠ¸ í‚¤ì›€) === */
body{font-family:sans-serif; margin:10px; font-size:15px;} /* 12px -> 15px í™•ëŒ€ */
table{width:100%; border-collapse:collapse; table-layout:fixed; margin-top:5px;}
th,td{border:1px solid #ccc; padding:4px 4px; text-align:center; vertical-align:middle; height: 42px;} /* ë†’ì´ 28px -> 42px í™•ëŒ€ */
input,select,button{font:inherit; font-size:15px;} /* ì…ë ¥ì°½ í°íŠ¸ë„ í™•ëŒ€ */

/* === ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ === */
#grid td > input { width: 100%; padding: 4px; box-sizing: border-box; text-align: right; border:none; background: transparent; height: 32px; line-height: 24px;}
#grid td > input:focus { background: #fff; outline: 2px solid #aaa; }
#grid td input.name { text-align: left; font-weight: bold; } /* ì¢…ëª©ëª…ì€ êµµê²Œ */
#grid td input.code { text-align: center; color: #666; font-size: 13px; } /* ì½”ë“œëŠ” ì‚´ì§ ì‘ê²Œ */
#grid td input[type="date"] { font-size: 13px; text-align: center; height: 28px; }

td input[readonly]{background:#f9f9f9; color:#555}
.status{font-size:13px; font-weight:bold;}
.profit-pos{color:#d32f2f; font-weight:bold} /* ë¹¨ê°•(ìˆ˜ìµ) ì¡°ê¸ˆ ë” ì§„í•˜ê²Œ */
.profit-neg{color:#1976d2; font-weight:bold} /* íŒŒë‘(ì†ì‹¤) ì¡°ê¸ˆ ë” ì§„í•˜ê²Œ */

/* === ë²„íŠ¼ ë° ì•¡ì…˜ (í„°ì¹˜í•˜ê¸° ì¢‹ê²Œ í‚¤ì›€) === */
.actions{display:inline-flex; align-items:center; gap:4px; white-space:nowrap; justify-content:center}
.mv{display:inline-flex; gap:2px}
.mv button, .del, .chart-btn {
    min-width: 28px; height: 28px; font-size: 13px; padding: 0 6px; 
    cursor:pointer; border:1px solid #999; background:#eee; border-radius:4px;
}
.del{ background:#ffebee; border-color:#ef9a9a; color:#c62828; }
.chart-btn{ background:#e3f2fd; border-color:#90caf9; color:#1565c0; }
#resetBtn { background: #333; color: #fff; border: 1px solid #000; font-weight: bold; padding: 6px 12px; }

/* === ëª©í‘œê°€ ì  (ì¡°ê¸ˆ í‚¤ì›€) === */
@keyframes pulseRed {0%{box-shadow:0 0 0 0 rgba(255,0,0,.8);}100%{box-shadow:0 0 0 6px rgba(255,0,0,0);}}
@keyframes pulseBlue{0%{box-shadow:0 0 0 0 rgba(0,100,255,.8);}100%{box-shadow:0 0 0 6px rgba(0,100,255,0);}}
.dot{width:8px; height:8px; border-radius:50%; background:#ccc; display:inline-block; flex-shrink:0;}
.dot.red{background:#ff1744}
.dot.blue{background:#2979ff}
.blink-red-dot{animation:pulseRed .9s infinite;}
.blink-blue-dot{animation:pulseBlue .9s infinite;}
.target-cell{display:flex; align-items:center; gap:6px; justify-content:center; width:100%;}
.target-cell input { flex: 1; min-width: 0; font-size: 14px; } /* ëª©í‘œê°€ëŠ” ì‚´ì§ ì‘ê²Œ */

/* === ìƒë‹¨ í•„í„° ë°” === */
.filter-bar { margin: 10px 0; display:flex; gap: 8px; align-items: center; padding: 8px; background: #f0f0f0; border-radius: 8px; border: 1px solid #ddd; flex-wrap:wrap; }
.filter-label { font-weight: bold; margin-right: 4px; font-size: 14px;}
.filter-btn { padding: 8px 16px; border: 1px solid #bbb; background: #fff; cursor: pointer; border-radius: 6px; font-size: 14px; font-weight: bold; color: #555;}
.filter-btn.active { background: #424242; color: #fff; border-color: #000; }

/* === ê·¸ë£¹ ë°°ì§€ ë²„íŠ¼ === */
.grp-btn { width: 32px; height: 24px; font-size: 13px; font-weight:bold; border:1px solid rgba(0,0,0,0.2); border-radius: 4px; cursor:pointer; padding:0;}
.grp-short { background: #ffebee; color: #c62828; } 
.grp-long  { background: #e3f2fd; color: #1565c0; }

/* === í† ìŠ¤íŠ¸, ìƒë‹¨ ë°°ì§€ === */
.top-total{position:fixed; top:60px; right:20px; z-index:6; background:#fff; border:2px solid #ccc; padding:8px 16px; border-radius:12px; box-shadow:0 4px 14px rgba(0,0,0,.15); font-weight:bold; font-size: 16px;}
.total-pos{color:#d32f2f; border-color:#ef9a9a;} 
.total-neg{color:#1976d2; border-color:#90caf9;}

/* === íŠ¸ë Œë“œ ì  (ìœ„ì¹˜ ì¡°ì • ë° í™•ëŒ€) === */
td.cur-cell { position: relative; }
td.cur-cell .trend-dots { position: absolute; right: 4px; bottom: 4px; display:flex; gap:3px; pointer-events:none;} 
.trend-dot { width:6px; height:6px; border-radius:50%; background:#ddd; opacity:.5 }
.trend-dot.up   { background:#d32f2f; opacity:1; }
.trend-dot.down { background:#1976d2; opacity:1; }

/* === D-Day ë°°ì§€ === */
.date-cell { display:flex; flex-direction:column; align-items:center; gap:2px; }
.d-day-badge { font-size:11px; font-weight:bold; color:#fff; background:#90a4ae; padding:2px 6px; border-radius:4px; display:inline-block; min-width:30px; line-height: 1.2;}
.d-day-badge.new { background: #ff9800; } 
.d-day-badge.old { background: #607d8b; } 

/* === ì»¬ëŸ¼ í­ ì„¤ì • (ì¡°ê¸ˆì”© ë” ë„“ê²Œ) === */
col.col-no { width: 35px; }
col.col-group { width: 45px; }
col.col-code { width: 65px; }
col.col-name { width: 110px; } /* ì´ë¦„ ì¹¸ í™•ë³´ */
col.col-date { width: 95px; } 
col.col-avg { width: 75px; }
col.col-qty { width: 45px; }
col.col-inv { width: 90px; }
col.col-target { width: 90px; }
col.col-cur { width: 85px; }
col.col-fix { width: 80px; }
col.col-profit { width: 85px; }
col.col-percent { width: 65px; }
col.col-act { width: 130px; }

@media (max-width: 600px) {
  .actions { flex-wrap: wrap; }
  .filter-bar { flex-wrap: wrap; }
  body { font-size: 14px; } /* ëª¨ë°”ì¼ì—ì„œëŠ” ì•½ê°„ ì¡°ì ˆ */
}
</style>
</head>
<body>

<div>
  <details>
    <summary style="cursor:pointer; margin-bottom:8px; font-weight:bold; color:#555; font-size:14px;">âš™ï¸ ì„¤ì • (API/í”„ë¡ì‹œ)</summary>
    <div style="padding:15px; background:#f8f8f8; border:1px solid #ddd; margin-bottom:15px; border-radius: 8px;">
      <label>í”„ë¡ì‹œ <input id="apiBase" value="https://stock-dashboard.respite9.workers.dev" style="width:100%"></label><br>
      <div style="margin-top:8px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <label>ëª¨ë“œ <select id="apiMode" style="height:30px;"><option value="auto" selected>ìë™</option><option value="multi">ë©€í‹°</option><option value="single">ë‹¨ê±´</option></select></label>
        <label>Code <input id="codeParam" value="code" style="width:50px"></label>
        <label>Price <input id="priceKey" value="price" style="width:50px"></label>
        <label>ì£¼ê¸°(ì´ˆ) <input id="pollSec" type="number" value="10" min="2" style="width:50px"></label>
        <button id="resetBtn" style="margin-left:auto;">âš ï¸ë°ì´í„° ì´ˆê¸°í™”</button>
      </div>
    </div>
  </details>
  
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
    <div style="display:flex; align-items:center; gap:12px;">
      <label style="font-size:16px; display:flex; align-items:center;"><input type="checkbox" id="liveToggle" checked style="width:18px; height:18px; margin-right:6px;"> <b>ì‹¤ì‹œê°„ ê°±ì‹ </b></label>
      <span id="status" class="status">ëŒ€ê¸°</span>
    </div>
    <div id="topTotal" class="top-total" style="position:static; margin:0; box-shadow:none; border:none; background:transparent;">ì´ ì†ìµ: 0</div>
  </div>

  <div class="filter-bar">
    <span class="filter-label">ë³´ê¸°:</span>
    <button class="filter-btn active" data-filter="short">ë‹¨íƒ€ë§Œ</button>
    <button class="filter-btn" data-filter="long">ì¥íˆ¬ë§Œ</button>
    <button class="filter-btn" data-filter="all">ì „ì²´</button>
    
    <div style="width:1px; height:24px; background:#ccc; margin:0 8px;"></div>
    
    <label style="cursor:pointer; font-weight:bold; display:flex; align-items:center; background:#fff; padding:6px 12px; border:1px solid #ccc; border-radius:6px;">
        <input type="checkbox" id="hideSoldToggle" style="width:18px; height:18px; margin-right:6px;"> ë§¤ë„ìˆ¨ê¹€
    </label>
  </div>

  <div style="display:flex; gap:6px; flex-wrap:wrap; margin-bottom:8px;">
    <button id="addRowBtn" style="font-weight:bold; color:#1565c0; padding: 6px 12px;">+ ì¢…ëª©ì¶”ê°€</button>
    <button id="saveBtn" style="padding: 6px 12px;">ì €ì¥</button>
    <button id="cloudSaveBtn" style="padding: 6px 12px;">â˜ï¸í´ë¼ìš°ë“œì €ì¥</button>
    <button id="cloudLoadBtn" style="padding: 6px 12px;">â˜ï¸ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <button id="copyTxtBtn" style="padding: 6px 12px;">ğŸ“‹ë³µì‚¬</button>
    <button id="btnSortEmptyQty" style="padding: 6px 12px;">ì •ë ¬(ìˆ˜ìµìˆœ)</button>
    <button id="btnSetTargets" style="padding: 6px 12px;">ëª©í‘œê°€ìë™</button>
  </div>
</div>

<table id="grid">
  <colgroup>
    <col class="col-no">
    <col class="col-group"> <col class="col-code">
    <col class="col-name">
    <col class="col-date">
    <col class="col-avg">
    <col class="col-qty">
    <col class="col-inv">
    <col class="col-target">
    <col class="col-target">
    <col class="col-cur">
    <col class="col-fix">
    <col class="col-profit">
    <col class="col-percent">
    <col class="col-act">
  </colgroup>
  <thead><tr>
    <th>No</th><th>êµ¬ë¶„</th><th>ì½”ë“œ</th><th>ì´ë¦„</th><th>ë³´ìœ ì¼</th>
    <th>ë§¤ìˆ˜ê°€</th><th>ì£¼ìˆ˜</th><th>íˆ¬ì…ê¸ˆ</th>
    <th>ìƒëª©í‘œ</th><th>í•˜ëª©í‘œ</th><th>í˜„ì¬ê°€</th><th>ë§¤ë„ê°€</th><th>ì†ìµ</th><th>%</th><th>ë™ì‘</th>
  </tr></thead>
  <tbody id="tbody"></tbody>
</table>
<div style="text-align:right; margin-top:10px; font-weight:bold; font-size:16px;">
  <span id="profitLabel">ì´ ì†ìµ</span>: <span id="totalProfit" class="profit-neg">0</span> (ìˆ˜ìˆ˜ë£Œ 0.26% ë°˜ì˜)
</div>

<div id="chartModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:999; align-items:center; justify-content:center;">
  <div style="background:#fff; width:95%; max-width:700px; max-height:85vh; display:flex; flex-direction:column; padding:20px; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.3);">
    <div style="display:flex; justify-content:space-between; margin-bottom:15px; flex-shrink:0;">
      <strong id="chartTitle" style="font-size:18px;">ì°¨íŠ¸</strong>
      <button onclick="document.getElementById('chartModal').style.display='none'" style="padding:6px 12px; font-size:14px;">ë‹«ê¸°</button>
    </div>
    <div style="flex:1; min-height:0; overflow:hidden;">
      <canvas id="histChart" style="width:100%; height:100%;"></canvas>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ==========================================
// 1. ìœ í‹¸ë¦¬í‹° ë° ì„¤ì •
// ==========================================
const $=(s)=>document.querySelector(s);
const $$=(s)=>document.querySelectorAll(s);
const fmt=(n)=>(n??0).toLocaleString('ko-KR');
const toNum=(v)=>Number(String(v||'').replace(/,/g,''))||0;

const FEE_BUY=0.00015, FEE_SELL=0.00015, TAX_SELL=0.00230; 
function calcProfit(avg,cur,fix,qty){
  const base=(fix && fix!==0) ? fix : cur;
  if(!avg||!qty||!base) return {won:0,pct:0};
  const buyAmt=avg*qty;
  const sellAmt=base*qty;
  const totalCost = (buyAmt * FEE_BUY) + (sellAmt * (FEE_SELL + TAX_SELL));
  const profit = sellAmt - buyAmt - totalCost;
  return {won:profit, pct: (profit/buyAmt)*100};
}

function getDDay(dateStr) {
    if(!dateStr) return '';
    const target = new Date(dateStr);
    target.setHours(0,0,0,0);
    const today = new Date();
    today.setHours(0,0,0,0);
    const diff = (today - target) / (1000 * 60 * 60 * 24);
    const d = Math.floor(diff);
    if(d === 0) return 'D-Day';
    if(d > 0) return 'D+'+d;
    return 'D'+d; 
}

const KEY_ROWS='rows_v5_final';
const KEY_SET ='set_v5_final';
let rows=[], settings={};
let currentFilter = 'short'; 

// ==========================================
// 2. ë°ì´í„° ê´€ë¦¬
// ==========================================
function loadJSON(k,d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d; }catch{ return d; } }
function saveJSON(k,o){ localStorage.setItem(k, JSON.stringify(o)); }

function loadAll(){
  const savedRows = loadJSON(KEY_ROWS,[]);
  rows = savedRows.map(r => {
    if(typeof r !== 'object' || r === null) return { group: 'short' };
    return { ...r, group: r.group || 'short' };
  });
  
  settings=Object.assign({
    apiBase:'https://stock-dashboard.respite9.workers.dev', 
    apiMode:'auto', pollSec:10, codeParam:'code', priceKey:'price'
  }, loadJSON(KEY_SET,{}));
  applySettingsToUI();
}

function applySettingsToUI(){
  $('#apiBase').value = settings.apiBase;
  $('#apiMode').value = settings.apiMode;
  $('#pollSec').value = settings.pollSec;
}

function saveSettings(){
  settings.apiBase=$('#apiBase').value.trim();
  settings.apiMode=$('#apiMode').value;
  settings.pollSec=Math.max(2, Number($('#pollSec').value)||10);
  saveJSON(KEY_SET,settings);
}
function saveRows(){ saveJSON(KEY_ROWS,rows); }

// ==========================================
// 3. ë Œë”ë§
// ==========================================
function render(){
  const tb=$('#tbody'); 
  if(!tb) return;
  tb.innerHTML='';
  
  const hideSold = $('#hideSoldToggle').checked;
  let displayIdx = 0;

  rows.forEach((r,i)=>{
    if(currentFilter === 'short' && r.group === 'long') return;
    if(currentFilter === 'long' && r.group === 'short') return;
    
    const isSold = (r.fix > 0);
    if(hideSold && isSold) return;

    displayIdx++;
    const tr=document.createElement('tr');
    tr.dataset.idx = i;
    const isLong = r.group === 'long';
    const grpClass = isLong ? 'grp-long' : 'grp-short';
    const grpText = isLong ? 'ì¥' : 'ë‹¨';
    const stepVal = (r.cur >= 100000) ? 500 : 100;
    
    const dDayStr = getDDay(r.date);
    const dDayClass = (dDayStr.startsWith('D+0') || dDayStr==='D-Day' || dDayStr.startsWith('D+1') || dDayStr.startsWith('D+2')) ? 'new' : 'old';
    const dDayBadge = dDayStr ? `<span class="d-day-badge ${dDayClass}">${dDayStr}</span>` : '';

    tr.innerHTML=`
      <td class="row-no">${displayIdx}</td>
      <td><button class="grp-btn ${grpClass}">${grpText}</button></td>
      <td><input class="code" value="${r.code||''}"></td>
      <td><input class="name" value="${r.name||''}"></td>
      
      <td><div class="date-cell">
        ${dDayBadge}
        <input type="date" class="date" value="${r.date||''}">
      </div></td>

      <td><input class="avg" value="${r.avg?fmt(r.avg):''}"></td>
      <td><input class="qty" value="${r.qty||''}"></td>
      <td><input class="inv" readonly value="${fmt((r.avg||0)*(r.qty||0))}"></td>
      
      <td><div class="target-cell"><span class="dot ut-dot"></span><input class="utarget" type="number" step="${stepVal}" value="${r.utarget||''}"></div></td>
      <td><div class="target-cell"><span class="dot lt-dot"></span><input class="ltarget" type="number" step="${stepVal}" value="${r.ltarget||''}"></div></td>
      
      <td class="cur-cell">
        <input class="cur" value="${r.cur?fmt(r.cur):''}" style="font-weight:bold; font-size:15px;">
        <div class="trend-dots"></div> </td>
      <td><input class="fix" value="${r.fix?fmt(r.fix):''}"></td>
      <td><span class="pw">0</span></td>
      <td><span class="pp">0%</span></td>
      <td>
        <span class="actions">
          <button class="chart-btn">ì°¨íŠ¸</button>
          <span class="mv">
            <button class="up">â–²</button>
            <button class="dn">â–¼</button>
          </span>
          <button class="del">ì‚­ì œ</button>
        </span>
      </td>`;
    
    tb.appendChild(tr);

    const bindInput = (sel, key, isNum) => {
      const el = tr.querySelector(sel);
      if(!el) return;
      el.addEventListener('change', ()=>{
        let val = el.value;
        if(isNum) val = toNum(val);
        rows[i][key] = val;
        saveRows();
        if(key === 'date') render(); 
        else updateRowCalculation(tr, rows[i]);
      });
      if(isNum && el.type !== 'number') {
        el.addEventListener('blur', ()=> el.value = rows[i][key] ? fmt(rows[i][key]) : '');
      }
    };

    bindInput('.code', 'code');
    bindInput('.name', 'name');
    bindInput('.date', 'date');
    bindInput('.avg', 'avg', true);
    bindInput('.qty', 'qty', true);
    bindInput('.cur', 'cur', true);
    bindInput('.fix', 'fix', true);
    bindInput('.utarget', 'utarget', true);
    bindInput('.ltarget', 'ltarget', true);

    const btnGrp = tr.querySelector('.grp-btn');
    if(btnGrp) btnGrp.onclick = () => {
       r.group = (r.group === 'short') ? 'long' : 'short';
       saveRows();
       render(); 
    };
    
    const btnDel = tr.querySelector('.del');
    if(btnDel) btnDel.onclick = () => { if(confirm('ì‚­ì œ?')) { rows.splice(i,1); saveRows(); render(); } };
    
    const btnUp = tr.querySelector('.up');
    if(btnUp) btnUp.onclick = () => { if(i>0) { [rows[i-1], rows[i]] = [rows[i], rows[i-1]]; saveRows(); render(); } };
    
    const btnDn = tr.querySelector('.dn');
    if(btnDn) btnDn.onclick = () => { if(i<rows.length-1) { [rows[i+1], rows[i]] = [rows[i], rows[i+1]]; saveRows(); render(); } };
    
    const btnChart = tr.querySelector('.chart-btn');
    if(btnChart) btnChart.onclick = () => showChart(r.code, r.name);
    
    updateRowCalculation(tr, r);
  });
  
  updateTotalProfit();
}

function updateRowCalculation(tr, r){
  r.inv = (r.avg||0) * (r.qty||0);
  tr.querySelector('.inv').value = fmt(r.inv);

  const {won, pct} = calcProfit(r.avg, r.cur, r.fix, r.qty);
  const pw = tr.querySelector('.pw');
  const pp = tr.querySelector('.pp');
  
  if(pw) {
    pw.textContent = fmt(Math.round(won));
    pw.className = 'pw ' + (won >= 0 ? 'profit-pos' : 'profit-neg');
  }
  if(pp) {
    pp.textContent = pct.toFixed(2) + '%';
    pp.className = 'pp ' + (pct >= 0 ? 'profit-pos' : 'profit-neg');
  }

  const utDot = tr.querySelector('.ut-dot');
  const ltDot = tr.querySelector('.lt-dot');
  const upReached = r.utarget > 0 && r.cur >= r.utarget;
  const downReached = r.ltarget > 0 && r.cur <= r.ltarget;
  
  if(utDot) utDot.className = 'dot ut-dot' + (upReached ? ' red blink-red-dot' : '');
  if(ltDot) ltDot.className = 'dot lt-dot' + (downReached ? ' blue blink-blue-dot' : '');

  const hasQty = (r.qty > 0);
  const hasFix = (r.fix > 0);
  const curTd = tr.querySelector('.cur').closest('td');
  if(hasQty && !hasFix) {
    curTd.style.backgroundColor = '#e0f7fa'; 
    tr.querySelector('.qty').style.fontWeight = 'bold';
  } else if(hasFix) {
    curTd.style.backgroundColor = ''; 
    tr.querySelector('.fix').closest('td').style.backgroundColor = '#eee'; 
  } else {
    curTd.style.backgroundColor = '';
  }

  updateHistoryVisuals(tr, r.code, r.cur);
}

function updateTotalProfit(){
  let total = 0;
  const hideSold = $('#hideSoldToggle').checked;

  rows.forEach(r => {
    if(currentFilter === 'short' && r.group === 'long') return;
    if(currentFilter === 'long' && r.group === 'short') return;
    if(hideSold && r.fix > 0) return;

    const {won} = calcProfit(r.avg, r.cur, r.fix, r.qty);
    total += won;
  });
  
  const label = hideSold ? 'ìš´ì˜ ì†ìµ' : 'ì´ ì†ìµ';
  const el = $('#totalProfit');
  if(el) {
    el.textContent = fmt(Math.round(total));
    el.className = total >= 0 ? 'profit-pos' : 'profit-neg';
  }
  $('#profitLabel').textContent = label;
  
  const topEl = $('#topTotal');
  if(topEl) {
    topEl.textContent = label + ': ' + fmt(Math.round(total));
    topEl.className = 'top-total ' + (total >= 0 ? 'total-pos' : 'total-neg');
  }
}

// ==========================================
// 4. API í´ë§
// ==========================================
async function fetchPrices(){
  if(!rows.length) return;
  const codes = rows.map(r => r.code).filter(c => c && c.length >= 6);
  if(!codes.length) return;

  const uniqueCodes = [...new Set(codes)].map(c => {
    let code = c.trim().toUpperCase();
    if(/^\d{6}$/.test(code)) return code; 
    return code.replace('.KS','').replace('.KQ','');
  });

  const url = `${settings.apiBase}/api/prices?codes=${uniqueCodes.join(',')}&t=${Date.now()}`;
  
  setStatus('ê°±ì‹ ì¤‘...', true);
  try {
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const json = await res.json();
    const data = json.data || [];
    
    const priceMap = {};
    data.forEach(d => {
      const code = d.code || d.cd || d.symbol;
      const price = d.price || d.nv || d.last;
      if(code) priceMap[code] = Number(price);
    });

    let changed = false;
    rows.forEach(r => {
      if(!r.code) return;
      const key = r.code.replace('.KS','').replace('.KQ','');
      if(priceMap[key]) {
        if(r.cur !== priceMap[key]) {
          r.cur = priceMap[key];
          addSnapshot(r.code, r.cur); 
          changed = true;
        }
      }
    });

    if(changed) {
      saveRows();
      render(); 
    }
    setStatus('OK ' + new Date().toLocaleTimeString(), true);
  } catch(e) {
    console.error(e);
    setStatus('ì—ëŸ¬: '+e.message, false);
  }
}

let timerId = null;
function startPolling(){
  if(timerId) clearInterval(timerId);
  const sec = Math.max(2, Number($('#pollSec').value));
  timerId = setInterval(() => {
    if($('#liveToggle').checked) fetchPrices();
  }, sec * 1000);
  if($('#liveToggle').checked) fetchPrices();
}

function setStatus(msg, isOk){
  const el = $('#status');
  if(el) {
    el.textContent = msg;
    el.style.color = isOk ? 'green' : 'red';
  }
}

// ==========================================
// 5. íˆìŠ¤í† ë¦¬ & ì°¨íŠ¸
// ==========================================
const HIST_KEY_PREFIX = "hist_";
function getHistKey(code) { return HIST_KEY_PREFIX + code; }
function loadHist(code){ try{ return JSON.parse(localStorage.getItem(getHistKey(code)))||[]; }catch{return[];} }
function addSnapshot(code, price){
  const key = getHistKey(code);
  let hist = loadHist(code);
  const now = Date.now();
  const last = hist[hist.length-1];
  if(!last || (now - last.t > 5*60*1000)) {
    hist.push({t:now, p:price});
    if(hist.length > 200) hist.shift(); 
    localStorage.setItem(key, JSON.stringify(hist));
  }
}

function updateHistoryVisuals(tr, code, cur){
  if(!code || !cur) return;
  const hist = loadHist(code);
  if(!hist.length) return;

  const dotsBox = tr.querySelector('.trend-dots');
  if(dotsBox && hist.length >= 2) {
    const recent = hist.slice(-6); 
    let dotsHtml = '';
    for(let i=1; i<recent.length; i++){
       const prev = recent[i-1].p;
       const curr = recent[i].p;
       const cls = curr > prev ? 'up' : (curr < prev ? 'down' : '');
       if(cls) dotsHtml += `<span class="trend-dot ${cls}"></span>`;
    }
    dotsBox.innerHTML = dotsHtml;
  }
}

function showChart(code, name){
  const hist = loadHist(code);
  if(!hist.length) { alert('íˆìŠ¤í† ë¦¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
  
  const ctx = $('#histChart').getContext('2d');
  if(window.myChart) window.myChart.destroy();
  
  window.myChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: hist.map(h => new Date(h.t).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})),
      datasets: [{
        label: name || code,
        data: hist.map(h => h.p),
        borderColor: '#ff4d4d',
        tension: 0.1,
        pointRadius: 2
      }]
    },
    options: { 
      responsive: true, 
      maintainAspectRatio: false 
    }
  });
  
  $('#chartTitle').textContent = `${name} (${code})`;
  $('#chartModal').style.display = 'flex';
}

// ==========================================
// 6. ì´ë²¤íŠ¸ ë“±ë¡
// ==========================================
document.addEventListener('DOMContentLoaded', () => {
  // í•„í„° ë²„íŠ¼
  $$('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      $$('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentFilter = btn.dataset.filter;
      render();
    });
  });
  
  // ë§¤ë„ìˆ¨ê¹€ í† ê¸€
  $('#hideSoldToggle').addEventListener('change', render);

  // ì •ë ¬ ë¡œì§ (ìš´ì˜ì¤‘ -> ë§¤ë„ -> ê´€ë§)
  $('#btnSortEmptyQty').addEventListener('click', () => {
    const active = []; 
    const sold = [];   
    const watch = [];  

    rows.forEach(r => {
      if(r.fix > 0) sold.push(r);
      else if(r.qty > 0) active.push(r);
      else watch.push(r);
    });

    active.sort((a,b) => {
      const pa = calcProfit(a.avg, a.cur, a.fix, a.qty).won;
      const pb = calcProfit(b.avg, b.cur, b.fix, b.qty).won;
      return pb - pa;
    });
    
    watch.sort((a,b) => (a.name||'').localeCompare(b.name||''));

    rows = [...active, ...sold, ...watch];
    saveRows();
    render();
  });

  // ëª©í‘œê°€ ì„¸íŒ…
  $('#btnSetTargets').addEventListener('click', () => {
    let changed = 0;
    rows.forEach(r => {
      if(r.fix > 0) return;
      if(r.qty > 0 && r.avg > 0) {
        const buyAmt = r.avg * r.qty;
        const fee = buyAmt * 0.0026; 
        r.utarget = Math.round((buyAmt + fee + 10000) / r.qty);
        r.ltarget = Math.round((buyAmt + fee - 10000) / r.qty);
        changed++;
      } else if(!r.qty && r.cur > 0) {
        const delta = (r.cur >= 100000) ? 3000 : 300;
        r.utarget = r.cur + delta;
        r.ltarget = Math.max(0, r.cur - delta);
        changed++;
      }
    });
    if(changed > 0) {
      saveRows();
      render();
      alert(`ëª©í‘œê°€ ì„¸íŒ… ì™„ë£Œ (${changed}ê±´)`);
    } else {
      alert('ë³€ê²½í•  ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.');
    }
  });

  // [ìˆ˜ì •ëœ ê¸°ëŠ¥] ë³´ì´ëŠ” ë°ì´í„°ë§Œ ë³µì‚¬
  $('#copyTxtBtn').addEventListener('click', () => {
    const headers = ['êµ¬ë¶„', 'ì½”ë“œ', 'ì´ë¦„', 'ë³´ìœ ì¼', 'ë§¤ìˆ˜ê°€', 'ì£¼ìˆ˜', 'íˆ¬ì…ê¸ˆ', 'ìƒëª©í‘œ', 'í•˜ëª©í‘œ', 'í˜„ì¬ê°€', 'ë§¤ë„ê°€', 'ì†ìµ', 'ìˆ˜ìµë¥ '];
    
    const hideSold = $('#hideSoldToggle').checked;
    const visibleRows = rows.filter(r => {
        if(currentFilter === 'short' && r.group === 'long') return false;
        if(currentFilter === 'long' && r.group === 'short') return false;
        if(hideSold && r.fix > 0) return false;
        return true;
    });

    const lines = visibleRows.map(r => {
      const grp = r.group === 'long' ? 'ì¥íˆ¬' : 'ë‹¨íƒ€';
      const {won, pct} = calcProfit(r.avg, r.cur, r.fix, r.qty);
      const dDay = getDDay(r.date);

      return [
        grp,
        r.code || '',
        r.name || '',
        dDay + (r.date ? `(${r.date})` : ''),
        r.avg || 0,
        r.qty || 0,
        (r.avg||0) * (r.qty||0),
        r.utarget || 0,
        r.ltarget || 0,
        r.cur || 0,
        r.fix || 0,
        Math.round(won),
        (pct||0).toFixed(2) + '%'
      ].join('\t');
    });

    const txt = headers.join('\t') + '\n' + lines.join('\n');
    navigator.clipboard.writeText(txt).then(()=>alert(`ë³´ì´ëŠ” ë°ì´í„°(${visibleRows.length}ê±´) ë³µì‚¬ ì™„ë£Œ!`));
  });

  // í´ë¼ìš°ë“œ ì €ì¥
  const CLOUD_URL = "https://script.google.com/macros/s/AKfycbz9ZQB_vvGIkRVbURaj4g8pdeSf2Dy1GoRvn_1F1T_q8lJqvo6DmXZpt6V9-5XjxuvhUA/exec";
  const CLOUD_ID = "stock-dashboard-rows";

  $('#cloudSaveBtn').addEventListener('click', async () => {
    if(!confirm('í´ë¼ìš°ë“œ(Google)ì— ì €ì¥í• ê¹Œìš”?')) return;
    try {
      const res = await fetch(CLOUD_URL + "?id=" + CLOUD_ID, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=UTF-8" },
        body: JSON.stringify({ rows, settings, ts: Date.now() })
      });
      if(res.ok) alert('ì €ì¥ ì„±ê³µ!');
      else alert('ì €ì¥ ì‹¤íŒ¨: ' + res.status);
    } catch(e) { alert('ì—ëŸ¬: '+e.message); }
  });

  $('#cloudLoadBtn').addEventListener('click', async () => {
    if(!confirm('í´ë¼ìš°ë“œì—ì„œ ë¶ˆëŸ¬ì˜¤ë©´ í˜„ì¬ ë°ì´í„°ê°€ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.')) return;
    try {
      const res = await fetch(CLOUD_URL + "?id=" + CLOUD_ID);
      const json = await res.json();
      if(json.rows) {
        rows = json.rows;
        rows = rows.map(r => ({ ...r, group: r.group || 'short' }));
        saveRows();
      }
      if(json.settings) {
        settings = Object.assign(settings, json.settings);
        saveSettings();
        applySettingsToUI();
      }
      render();
      alert('ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ');
    } catch(e) { alert('ì—ëŸ¬: '+e.message); }
  });

  $('#addRowBtn').addEventListener('click', () => {
    rows.unshift({ group: currentFilter==='long'?'long':'short' });
    saveRows();
    render();
  });
  
  $('#resetBtn').addEventListener('click', () => {
    if(confirm('âš ï¸ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?')) {
      rows = [];
      saveRows();
      render();
      alert('ì´ˆê¸°í™” ì™„ë£Œ.');
    }
  });

  loadAll();
  render();
  startPolling();
});

</script>
</body>
</html>
