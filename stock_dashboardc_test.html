<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>v14 주식 대시보드 v3.4h (그룹 필터 · 동적 step 100/500 · 텍스트 복사 FIX)</title>
<style>
body{font-family:sans-serif;margin:10px;font-size:12px}
table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:12px}
th,td{border:1px solid #ccc;padding:2px;text-align:center;vertical-align:middle}
input,select,button{font:inherit;font-size:12px}
td input[readonly]{background:#f9f9f9}
.status{font-size:11px}
.profit-pos{color:green}
.profit-neg{color:red}
.actions{display:inline-flex;align-items:center;gap:4px;white-space:nowrap;justify-content:center}
.mv{display:inline-flex;gap:2px}
.mv button,.del{width:18px;height:18px;font-size:10px;padding:0;margin:0}
.del{width:auto;padding:0 6px;height:20px;font-size:11px}
@keyframes pulseRed {0%{box-shadow:0 0 0 0 rgba(255,0,0,.8);}100%{box-shadow:0 0 0 6px rgba(255,0,0,0);}}
@keyframes pulseBlue{0%{box-shadow:0 0 0 0 rgba(0,100,255,.8);}100%{box-shadow:0 0 0 6px rgba(0,100,255,0);}}
.dot{width:8px;height:8px;border-radius:50%;background:#bbb;display:inline-block;flex:0 0 8px}
.dot.red{background:#ff4d4d}
.dot.blue{background:#3d7bff}
.blink-red-dot{animation:pulseRed .9s infinite;}
.blink-blue-dot{animation:pulseBlue .9s infinite;}
.target-cell{display:flex;align-items:center;gap:6px;justify-content:center}
.toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#333;color:#fff;padding:8px 12px;border-radius:8px;opacity:.95;z-index:9999}

/* === Added: sticky top total badge === */
.top-total{position:fixed;top:50px;right:12px;z-index:6;background:#fff;border:1px solid #ccc;padding:4px 10px;border-radius:10px;box-shadow:0 4px 14px rgba(0,0,0,.08);font-weight:700}
.total-pos{color:green} .total-neg{color:red}

/* === Added: bottom bar === */
.bottom-bar{display:flex;justify-content:flex-end;gap:8px;padding:6px 0}

/* === Added: small move10 buttons === */
.mv .up10,.mv .down10{width:auto;height:18px;font-size:10px;padding:0 6px}

/* === Added: delta badges (up=red, down=blue) === */
.delta-badges{display:inline-flex;gap:4px;margin-left:6px;font-size:11px}
.delta-badge{border:1px solid #ccc;border-radius:8px;padding:0 6px;line-height:18px}
.delta-pos{color:#c00;border-color:#c00}
.delta-neg{color:#1e5aff;border-color:#1e5aff}

/* ################ 컬럼 폭 ################## */
col.col-no { width: 44px; }     /* 필요하면 36~52px로 조절 */
col.col-group { width: 70px; }  /* 그룹 컬럼폭 */
col.col-code { width: 70px; }  /* 코드 컬럼폭 */
col.col-summary { width: 40px; }   /* 요약 컬럼폭 */
col.col-avg { width: 80px; }   /*  매수가 컬럼폭 */
col.col-qty { width: 40px; }   /*  주수 컬럼폭 */
col.col-inv { width: 90px; }   /*  투입금액 컬럼폭 */
col.col-utarget { width: 100px; }   /*  상목표 컬럼폭 */
col.col-ltarget { width: 100px; }   /*  하목표 컬럼폭 */
col.col-cur { width: 80px; }   /*  현재가 컬럼폭 */
col.col-fix { width: 80px; }   /*  매도가 컬럼폭, 가로폭 고정 */
col.col-profit { width: 70px; }   /* 손익(원) 컬럼폭 */
col.col-percent { width: 60px; }   /* 손익(율) 컬럼폭 */
col.col-act { width: 210px; }  /* 버튼 컬럼폭 */

/* 그룹 셀 select 폭 */
td select.group { width: 60px; }

/* 기존 Δ배지 숨김 */
.delta, .delta-badge, .delta-wrap { display: none !important; }

/* 현재가 셀 하단 공간 확보 + 점 5개 위치 */
td.cur-cell { position: relative; padding-bottom: 16px; }
td.cur-cell .trend-dots { position: absolute; left:50%; transform:translateX(-50%); bottom:1px; display:flex; gap:6px; }
.trend-dot { width:8px; height:8px; border-radius:50%; background:#bfbfbf; opacity:.35 }
.trend-dot.up   { background:#e53935; animation:blink 1s infinite; }
.trend-dot.down { background:#1e88e5; animation:blink 1s infinite; }
@keyframes blink { 0%,100%{opacity:.25} 50%{opacity:1} }
.trend-dot.small  { transform: scale(0.9);  opacity:.45; animation-duration:1.3s; }
.trend-dot.medium { transform: scale(1.0);  opacity:.75; animation-duration:1.0s; }
.trend-dot.big    { transform: scale(1.25); opacity:1.0;  animation-duration:0.7s; }

/* 동일(변화 거의 0)일 때는 회색 고정점 */
.trend-dot.flat { background:#bfbfbf !important; opacity:.6 !important; animation:none !important; }

/* 1) 셀 안 input을 셀 폭에 맞게 (전역 55% 규칙 덮어쓰기) */
#grid td > input {
  width: 100%; 
  padding: 2px 3px;
  margin: 0;
  box-sizing: border-box;
}

/* 2) 상/하목표 래퍼의 여백 축소 (점·input 사이 간격) */
#grid .target-cell { gap: 2px; }
#grid .target-cell input { width: 80px; }

/* 4) 셀 자체 패딩도 더 타이트하게 */
#grid td { padding: 5px 3px; }
</style>
</head>
<body>
<div>
  <label>프록시 <input id="apiBase" value="https://stock-dashboard.respite9.workers.dev" style="width:140px"></label>
  <label>엔드포인트 
    <select id="apiMode">
      <option value="auto" selected>자동</option>
      <option value="multi">멀티</option>
      <option value="single">단건</option>
    </select>
  </label>
  <label>코드파라미터 <input id="codeParam" value="code" style="width:70px"></label>
  <label>가격키(JSON) <input id="priceKey" value="price" style="width:90px"></label>
  <label>풀링(초) <input id="pollSec" type="number" value="10" min="2" style="width:48px"></label>
  <label><input type="checkbox" id="liveToggle" checked>실시간</label>
  <label>그룹 보기
    <select id="groupFilter">
      <option value="ALL" selected>전체</option>
      <option value="단타">단타</option>
      <option value="중장기">중장기</option>
      <option value="관망">관망</option>
    </select>
  </label>
  <button id="addRowBtn">+추가</button>
  <button id="saveBtn">저장</button>
  <button id="testBtn">테스트</button>
  <button id="cloudSaveBtn">클라우드 저장</button>
  <button id="cloudLoadBtn">클라우드 불러오기</button>
  <button id="copyTxtBtn">텍스트로 복사</button>
  <button id="btnSortEmptyQty">정렬(주수없음)</button>
  <button id="btnSetTargets">목표가 세팅</button>
  <span id="status" class="status">상태: 대기</span>
  <span id="sppp" class="sppp">&nbsp;&nbsp;&nbsp;&nbsp;</span>
  <span id="stmsg" class="stmsg">&nbsp;</span>
</div>

<table id="grid">
  <colgroup>
    <col class="col-no">
    <col class="col-group">
    <col class="col-code">
    <col class="col-summary">
    <col class="col-name">
    <col class="col-avg">
    <col class="col-qty">
    <col class="col-inv">
    <col class="col-utarget">
    <col class="col-ltarget">
    <col class="col-cur">
    <col class="col-fix">
    <col class="col-profit">
    <col class="col-percent">
    <col class="col-act">
  </colgroup>
  <thead><tr>
    <th>No</th><th>그룹</th><th>코드</th><th>요약</th><th>이름</th><th>매수가</th><th>주수</th><th>투입금액</th>
    <th>상목표</th><th>하목표</th><th>현재가</th><th>매도가</th><th>손익(원)</th><th>손익(%)</th><th>▲▼/삭제</th>
  </tr></thead>
  <tbody id="tbody"></tbody>
</table>
<div class="bottom-bar"><button id="addBottomBtn">+추가</button></div>
<div id="topTotal" class="top-total">총 손익: 0</div>
<div>총 손익: <span id="totalProfit" class="profit-neg">0</span> (수수료 0.26%)</div>

<!-- mobile polyfills: Promise.allSettled + safe fetch -->
<script>
// 1) Promise.allSettled 폴리필 (구형 삼성 인터넷)
if (!Promise.allSettled) {
  Promise.allSettled = function(promises){
    return Promise.all(promises.map(function(p){
      return Promise.resolve(p).then(
        function(value){ return {status:'fulfilled', value:value}; },
        function(reason){ return {status:'rejected',  reason:reason}; }
      );
    }));
  };
}

// 2) fetch 래퍼: 항상 CORS/omit
window.__fetch = function(url, init){
  init = init || {};
  if (!init.mode)        init.mode        = 'cors';
  if (!init.credentials) init.credentials = 'omit';
  return fetch(url, init);
};

// 3) 기본 프록시 자동 채우기(비어있거나 http/https 미포함일 때)
(function(){
  var def = 'https://stock-dashboard.respite9.workers.dev';
  var ip  = document.getElementById('apiBase');
  if (ip && (!ip.value || !/^https?:\/\//i.test(ip.value))) ip.value = def;
})();
</script>

<script>
const $=(s,el=document)=>el.querySelector(s);
const $$=(s,el=document)=>Array.from(el.querySelectorAll(s));
const fmt=(n)=>(n??0).toLocaleString('ko-KR');
const toNum=(v)=>{ if(v===''||v==null) return 0; if(typeof v==='number') return v; return Number(String(v).replace(/,/g,''))||0; };
const getByPath=(obj,path)=>{ if(!path) return undefined; const parts=String(path).split('.'); let cur=obj; for(const p of parts){ if(cur==null) return undefined; cur=cur[p]; } return cur; };

const FEE_BUY=0.00015, FEE_SELL=0.00015, TAX_SELL=0.00230;
function calcProfit(avg,cur,fix,qty){
  const base=(fix && !isNaN(fix) && fix!==0) ? fix : cur;
  if(!avg||!qty||!base) return {won:0,pct:0};
  const buyAmt=avg*qty, sellAmt=base*qty;
  const feeBuy=buyAmt*FEE_BUY, feeSell=sellAmt*(FEE_SELL+TAX_SELL);
  const profit=(sellAmt-buyAmt)-feeBuy-feeSell;
  return {won:profit, pct: profit/buyAmt*100};
}

const KEY_ROWS='rows_v34h_targetdot';
const KEY_SET ='set_v34h_targetdot';
let rows=[], settings={};
let currentGroupFilter='ALL';

function loadJSON(k,d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d; }catch{ return d; } }
function saveJSON(k,o){ localStorage.setItem(k, JSON.stringify(o)); }
function loadAll(){
  rows=loadJSON(KEY_ROWS,[]);
  settings=Object.assign({
    apiBase:'https://stock-dashboard.respite9.workers.dev', apiMode:'auto', codeParam:'code', priceKey:'price',
    multiTpl:'/api/prices?codes={codes}', singleTpl:'/api/price?{codeParam}={code}', pollSec:10
  }, loadJSON(KEY_SET,{}));
}
function saveSettings(){
  settings.apiBase=$('#apiBase').value.trim();
  settings.apiMode=$('#apiMode').value;
  settings.codeParam=$('#codeParam').value.trim();
  settings.priceKey=$('#priceKey').value.trim();
  settings.multiTpl=$('#multiTpl')?$('#multiTpl').value.trim():'/api/prices?codes={codes}';
  settings.singleTpl=$('#singleTpl')?$('#singleTpl').value.trim():'/api/price?{codeParam}={code}';
  settings.pollSec=Math.max(2, Number($('#pollSec').value)||10);
  saveJSON(KEY_SET,settings);
}
function saveRows(){ saveJSON(KEY_ROWS,rows); }

function normalizeCode(code){
  let c=(code||'').trim().toUpperCase();
  if(!c) return c;
  if(/^\d{6}$/.test(c)) c+='.KS';
  return c;
}
function normKey(c){
  return String(c || '').trim().toUpperCase().replace(/\.KS$/, '');
}

/* step 동적 조절 */
function adjustStepForRow(tr){
  const curEl  = tr.querySelector('.cur');
  const curVal = Number(String(curEl?.value || '').replace(/[^\d.-]/g,'')) || 0;
  const step   = curVal >= 100000 ? 500 : 100;
  tr.querySelectorAll('.utarget,.ltarget').forEach(inp => { if (inp) inp.step = step; });
}
function adjustAllSteps(){ $$('#tbody tr').forEach(adjustStepForRow); }

function render(){
  const tb=$('#tbody'); tb.innerHTML='';
  rows.forEach((r,i)=>{
    // 그룹 기본값: 없으면 현재 필터가 단일 그룹일 때 그 그룹으로
    const gVal = r.group || (currentGroupFilter!=='ALL' ? currentGroupFilter : '');
    r.group = gVal;

    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="row-no">${i+1}</td>
      <td>
        <select class="group">
          <option value=""${!gVal ? ' selected' : ''}></option>
          <option value="단타"${gVal==='단타'?' selected':''}>단타</option>
          <option value="중장기"${gVal==='중장기'?' selected':''}>중장기</option>
          <option value="관망"${gVal==='관망'?' selected':''}>관망</option>
        </select>
      </td>
      <td><input class="code" value="${r.code||''}" style="width: 60px; text-align:right;"></td>
      <td><input class="summary" value="${(r.name || '').trim().substring(0, 2)}" readonly style="width: 30px; text-align:center;"></td>
      <td><input class="name" value="${r.name||''}"></td>
      <td><input class="avg" value="${r.avg?fmt(r.avg):''}" style="width: 60px; text-align:right;"></td>
      <td><input class="qty" value="${r.qty||''}" style="width: 30px; text-align:right;"></td>
      <td><input class="inv" readonly style="width: 70px;"></td>
      <td><div class="target-cell"><span class="dot ut-dot"></span>
        <input type="number" min="0" step="100" class="utarget" value="${r.utarget||''}" title="상한목표가" style="width: 60px; text-align:right;">
      </div></td>
      <td><div class="target-cell"><span class="dot lt-dot"></span>
        <input type="number" min="0" step="100" class="ltarget" value="${r.ltarget||''}" title="하한목표가" style="width: 60px; text-align:right;">
      </div></td>
      <td class="cur-cell"><input class="cur" value="${r.cur?fmt(r.cur):''}" style="width: 60px; text-align:right;"></td>
      <td><input class="fix" value="${r.fix?fmt(r.fix):''}" title="매도가" style="width: 60px; text-align:right;"></td>
      <td><span class="pw">0</span></td>
      <td><span class="pp">0%</span></td>
      <td><span class="actions"><button class="chart">차트</button><span class="mv"><button class="up">▲</button><button class="up10">▲10</button><button class="down10">▼10</button><button class="down">▼</button></span><button class="del">삭제</button></span></td>`;

    tb.appendChild(tr);

    const upd=()=>applyRow(i,tr);
    $$('.group,.code,.name,.avg,.qty,.cur,.fix,.utarget,.ltarget',tr).forEach(inp=>{
      inp.addEventListener('input',upd);
      inp.addEventListener('blur',upd);
      inp.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); inp.blur(); } });
    });
    tr.querySelector('.del').onclick=()=>{ 
      if (!confirm("정말 삭제하시겠습니까?")) return;
      rows.splice(i,1); 
      saveRows(); 
      render(); 
    };
    const upBtn = tr.querySelector('.up');
    const downBtn = tr.querySelector('.down');
    if(upBtn){ upBtn.onclick=()=>{ if(i>0){ [rows[i-1],rows[i]]=[rows[i],rows[i-1]]; saveRows(); render(); } }; }
    if(downBtn){ downBtn.onclick=()=>{ if(i<rows.length-1){ [rows[i+1],rows[i]]=[rows[i],rows[i+1]]; saveRows(); render(); } }; }

    adjustStepForRow(tr);
  });
  updateProfits();
  applyGroupFilter();     // 그룹 필터 적용 + 번호 재정렬
}

// 현재 선택된 그룹 필터에 따라 행 숨기기
function applyGroupFilter(){
  const gf = $('#groupFilter');
  currentGroupFilter = gf ? gf.value : 'ALL';

  const trs = $$('#tbody tr');
  let visibleNo = 1;
  trs.forEach((tr, idx)=>{
    const r = rows[idx] || {};
    const g = (r.group || '').trim();
    const show = (currentGroupFilter === 'ALL' || g === currentGroupFilter);
    tr.style.display = show ? '' : 'none';
    if(show){
      const noCell = tr.querySelector('.row-no');
      if(noCell) noCell.textContent = visibleNo++;
    }
  });
}

function applyRow(i,tr,live){
  const r = rows[i] || (rows[i] = {});
  const get = (sel) => {
    const el = tr.querySelector(sel);
    return ((el ? el.value : '') || '').trim();
  };
  r.group  = get('.group');
  r.code   = get('.code');  
  const nameVal = get('.name');
  r.name = nameVal;
  const summaryInput = tr.querySelector('.summary');
  if (summaryInput) {
    const firstChar = nameVal ? nameVal.trim().substring(0, 2) : '';
    summaryInput.value = firstChar;
  }
  r.avg     = toNum(get('.avg'));
  r.qty     = toNum(get('.qty'));
  r.cur     = toNum(get('.cur'));
  r.fix     = toNum(get('.fix'));
  r.utarget = toNum(get('.utarget'));
  r.ltarget = toNum(get('.ltarget'));
  r.inv     = (r.avg||0) * (r.qty||0);

  tr.querySelector('.inv').value = fmt(r.inv || 0);
  if(!live){
    tr.querySelector('.avg').value = r.avg ? fmt(r.avg) : '';
    tr.querySelector('.cur').value = r.cur ? fmt(r.cur) : '';
    tr.querySelector('.fix').value = r.fix ? fmt(r.fix) : '';
  }
  adjustStepForRow(tr);
  saveRows();
  updateProfits();
  applyGroupFilter();
}

function updateProfits(){
  let total=0;
  $$('#tbody tr').forEach((tr,i)=>{
    const r=rows[i]||{};
    r.inv=(r.avg||0)*(r.qty||0);
    tr.querySelector('.inv').value=fmt(r.inv);
    const {won,pct}=calcProfit(r.avg,r.cur,r.fix,r.qty);
    total+=won;
    const pw=tr.querySelector('.pw'), pp=tr.querySelector('.pp');
    if(pw){ pw.textContent=fmt(Math.round(won)); pw.className='pw '+(won>=0?'profit-pos':'profit-neg'); }
    if(pp){ pp.textContent=(isFinite(pct)?pct.toFixed(2):'0.00')+'%'; }
    const utDot=tr.querySelector('.ut-dot'), ltDot=tr.querySelector('.lt-dot');
    const up=(r.utarget||0)>0 && (r.cur||0)>=r.utarget;
    const dn=(r.ltarget||0)>0 && (r.cur||0)<=r.ltarget;
    utDot.className='dot ut-dot'+(up?' red blink-red-dot':'');
    ltDot.className='dot lt-dot'+(dn?' blue blink-blue-dot':'');
    const qtyVal = Number(r.qty || 0);
    const hasQty = qtyVal > 0;
    const hasFix = !!r.fix && Number(r.fix) !== 0;

    const fixInput = tr.querySelector('.fix');
    const fixTd = fixInput ? fixInput.closest('td') : null;

    if (fixTd) {
      if (hasQty && !hasFix) {
        fixTd.style.backgroundColor = '#d9d9d9';
      } else {
        fixTd.style.backgroundColor = '';
      }
    }

    const curInput = tr.querySelector('.cur');
    const curTd = curInput ? curInput.closest('td') : null;
    if (curTd) {
      if (hasQty && !hasFix) {
        curTd.style.backgroundColor = '#b5f7e0';
      } else {
        curTd.style.backgroundColor = '';
      }
    }
  });
  const t=$('#totalProfit'); if(t){ t.textContent=fmt(Math.round(total)); t.className=(total>=0?'profit-pos':'profit-neg'); }
  saveRows();
}

function buildUrlMulti(codes){
  var base=(document.getElementById('apiBase').value||'').trim().replace(/\/$/,'');
  var path='/api/prices?codes='+encodeURIComponent(codes.join(','));
  return base+path+'&t='+Date.now();
}
	
function buildUrlSingle(code){
  const base=($('#apiBase').value||'').trim().replace(/\/$/,'');
  const tpl = '/api/price?{codeParam}={code}';
  const codeParam=($('#codeParam').value||'code').trim();
  const path=tpl.replace('{code}', encodeURIComponent(code))
                .replace('{codeParam}', encodeURIComponent(codeParam));
  return base + path + '&t=' + Date.now();
}

async function fetchPricesAuto(codes){
  const mode=$('#apiMode').value;
  try{
    if(mode==='multi'){ await fetchPricesMulti(codes); }
    else if(mode==='single'){ await fetchPricesSingle(codes); }
    else{ await fetchPricesMulti(codes).catch(()=>fetchPricesSingle(codes)); }
    setStatus('OK', true);
  }catch(err){
    console.warn(err);
    setStatus(err.message||'오류', false);
  }
}
	
// 멀티: /api/prices?codes=...
async function fetchPricesMulti(codes){
  saveSettings();
  const url = buildUrlMulti(codes.map(normalizeCode));
  const res = await __fetch(url, { cache: 'no-store' });
  if (!res.ok) throw new Error('HTTP ' + res.status);

  const j = await res.json();
  let arr = [];
  if (Array.isArray(j)) arr = j;
  else if (Array.isArray(j.data)) arr = j.data;
  else if (j && j.data && Array.isArray(j.data.data)) arr = j.data.data;
  else if (Array.isArray(j.results)) arr = j.results;
  else if (j && typeof j === 'object') {
    Object.keys(j).forEach(k => { if (Array.isArray(j[k])) arr = arr.concat(j[k]); });
  }

  const priceKey = ($('#priceKey').value || 'price').trim();
  const codeKey  = ($('#codeParam').value || 'code').trim();

  const priceMap = new Map();
  arr.forEach(p => {
    const rawCode =
      (p && (p[codeKey] || p.code || p.symbol || p.ticker || p.cd)) || '';
    const key = normKey(rawCode);
    const price =
      Number(getByPath(p, priceKey)) ||
      Number(p && p.price) ||
      Number(p && p.last) ||
      Number(p && p.nv) ||
      0;
    if (key) priceMap.set(key, price);
  });

  rows.forEach(row => {
    const key = normKey(row.code);
    if (priceMap.has(key)) {
      const v = priceMap.get(key);
      row.cur = (typeof v === 'number') ? v : (Number(v) || 0);
    }
  });
  saveRows();

  $$('#tbody tr').forEach((tr, i) => {
    const inp = tr.querySelector('.cur');
    if (!inp) return;
    const v = rows[i] && rows[i].cur;
    inp.value = (v || v === 0) ? (v ? fmt(v) : '') : '';
    adjustStepForRow(tr);
  });

  updateProfits();
  setStatus('OK', true);

  if (typeof render === 'function') {
    queueMicrotask(() => render());
  } else {
    document.querySelectorAll('#tbody tr').forEach((tr, i) => {
      const v = rows[i]?.cur;
      const inp = tr.querySelector('input.cur, input[name="cur"], input[data-col="cur"]');
      if (!inp) return;
      inp.value = (v || v === 0) ? (v ? fmt(v) : '') : '';
    });
  }
}

// 단건: /api/price?code=...
async function fetchPricesSingle(codes){
  saveSettings();
  const priceKey = ($('#priceKey').value || 'price').trim();

  const results = await Promise.allSettled(
    codes.map(async (code) => {
      const url = buildUrlSingle(normalizeCode(code));
      const res = await __fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const j = await res.json();

      const price =
        Number(getByPath(j, priceKey)) ||
        Number(j && j.price) ||
        Number(j && j.data && j.data.price) ||
        0;

      return { code: normKey(code), price };
    })
  );

  results.forEach(r => {
    if (r.status === 'fulfilled') {
      const { code, price } = r.value;
      rows.forEach(row => {
        if (normKey(row.code) === code) {
          row.cur = (typeof price === 'number') ? price : (Number(price) || row.cur || 0);
        }
      });
    }
  });

  saveRows();
  $$('#tbody tr').forEach((tr, i) => {
    const inp = tr.querySelector('.cur');
    if (inp) {
      const v = rows[i]?.cur;
      inp.value = v ? fmt(v) : '';
      adjustStepForRow(tr);
    }
  });

  updateProfits();
  setStatus('OK', true);

  if (typeof render === 'function') {
    queueMicrotask(() => render());
  } else {
    document.querySelectorAll('#tbody tr').forEach((tr, i) => {
      const v = rows[i]?.cur;
      const inp = tr.querySelector('input.cur, input[name="cur"], input[data-col="cur"]');
      if (!inp) return;
      inp.value = (v || v === 0) ? (v ? fmt(v) : '') : '';
    });
  }
}

let timerId=null;
function tick(){
  if(!$('#liveToggle').checked) return;
  const codes=rows.map(r=>r.code).filter(Boolean);
  if(!codes.length) return;
  fetchPricesAuto(codes);
}
function startPolling(){
  stopPolling();
  if(!$('#liveToggle').checked) return;
  const sec=Math.max(2, Number($('#pollSec').value)||10);
  timerId=setInterval(tick, sec*1000);
  tick();
}
function stopPolling(){ if(timerId){ clearInterval(timerId); timerId=null; } }

function setStatus(text, ok){
  const s=$('#status');
  if(s){ s.textContent='상태: '+text; s.style.color=ok?'green':'red'; }
}
function setSTmsg(text, ok){
  const s=$('#stmsg');
  var now = new Date();
  if(s){ s.textContent='msg : '+text + '  ' + now.toString(); s.style.color=ok?'blue':'red'; }
}

/* 텍스트로 복사 */
function showToast(msg){
  const t=document.createElement('div'); t.className='toast'; t.textContent=msg;
  document.body.appendChild(t); setTimeout(()=>t.remove(),1600);
}
function exportToText(){
  const headers=['코드','이름','매수가','주수','투입금액','상목표','하목표','현재가','매도가','손익(원)','손익(%)'];
  const lines=[headers.join('\t')];
  rows.forEach(r=>{
    const {code='',name='',avg=0,qty=0,inv=0,utarget=0,ltarget=0,cur=0,fix=0}=r||{};
    const {won,pct}=calcProfit(avg,cur,fix,qty);
    lines.push([
      code,
      name,
      fmt(avg),
      qty,
      fmt(inv),
      utarget?fmt(utarget):'',
      ltarget?fmt(ltarget):'',
      cur?fmt(cur):'',
      fix?fmt(fix):'',
      fmt(Math.round(won)),
      (isFinite(pct)?pct.toFixed(2):'0.00')+'%'
    ].join('\t'));
  });
  const out = lines.join('\r\n');
  if(navigator.clipboard){
    navigator.clipboard.writeText(out).then(()=>showToast('복사 완료! 엑셀에 붙여넣기(Ctrl+V) 하세요.'),()=>fallbackCopy(out));
  }else{ fallbackCopy(out); }
}
function fallbackCopy(text){
  const ta=document.createElement('textarea');
  ta.value=text; ta.style.position='fixed'; ta.style.left='-9999px';
  document.body.appendChild(ta); ta.focus(); ta.select();
  try{ document.execCommand('copy'); showToast('복사 완료! 엑셀에 붙여넣기(Ctrl+V) 하세요.'); }
  catch{ alert('복사 실패. 아래 텍스트를 수동 복사하세요:\n\n'+text); }
  finally{ ta.remove(); }
}

/* 초기 */
function ensureTopbar(){
  if(!document.getElementById('status')){
    const d=document.createElement('div');
    d.innerHTML='<span id="status" class="status">상태: 대기</span>';
    document.body.insertBefore(d, document.body.firstChild);
  }
}
function initRowsIfEmpty(){
  if(!rows.length){
    rows=[
      {code:'009830',name:'한화솔루션',avg:33800,qty:80,cur:30800,utarget:31400,ltarget:30000,group:'중장기'},
      {code:'000250',name:'삼천당제약',avg:241000,qty:5,cur:234000,utarget:234000,ltarget:220000,group:'중장기'},
      {code:'100090',name:'SK오션플랜트',avg:21950,qty:115,cur:20650,utarget:20550,ltarget:19800,group:'단타'},
      {code:'000660.KS',name:'SK하이닉스',avg:586000,qty:4,cur:581000,utarget:551000,ltarget:530000,group:'중장기'}
    ];
    saveRows();
  }
}
function bindTopbar(){
  const ids=['apiBase','apiMode','codeParam','priceKey','multiTpl','singleTpl','pollSec'];
  ids.forEach(id=>{ const el=document.getElementById(id); if(el){ el.addEventListener('change', saveSettings); } });
  const lt=document.getElementById('liveToggle'); if(lt){ lt.onchange=()=>{ if(lt.checked) startPolling(); else stopPolling(); }; }
  const add=document.getElementById('addRowBtn'); if(add){ add.onclick=()=>{ rows.push({group: (currentGroupFilter!=='ALL'?currentGroupFilter:'')}); saveRows(); render(); }; }
  const save=document.getElementById('saveBtn'); if(save){ save.onclick=()=>{ saveSettings(); saveRows(); alert('저장되었습니다.'); }; }
  const test=document.getElementById('testBtn'); if(test){ test.onclick=()=>{ const c=rows.map(r=>r.code).filter(Boolean); if(!c.length){alert('코드를 먼저 입력하세요');return;} fetchPricesAuto([c[0]]); }; }
  const copy=document.getElementById('copyTxtBtn'); if(copy){ copy.onclick=exportToText; }
  const cs=document.getElementById('cloudSaveBtn'); if(cs){ cs.onclick=cloudSave; }
  const cl=document.getElementById('cloudLoadBtn'); if(cl){ cl.onclick=cloudLoad; }
  const gf=document.getElementById('groupFilter'); if(gf){ gf.onchange=applyGroupFilter; }
}

function loadAllAndStart(){
  try{ const s=JSON.parse(localStorage.getItem(KEY_SET)||'null'); if(s) settings=s; }catch{}
  settings=Object.assign({
    apiBase:'https://stock-dashboard.respite9.workers.dev', apiMode:'auto', codeParam:'code', priceKey:'price',
    multiTpl:'/api/prices?codes={codes}', singleTpl:'/api/price?{codeParam}={code}', pollSec:10
  }, settings||{});
  [['apiBase','apiBase'],['apiMode','apiMode'],['codeParam','codeParam'],['priceKey','priceKey'],
   ['multiTpl','multiTpl'],['singleTpl','singleTpl'],['pollSec','pollSec']].forEach(([id,key])=>{
    const el=document.getElementById(id); if(el){ el.value=settings[key]; }
  });
}

loadAll();
loadAllAndStart();
bindTopbar();
ensureTopbar();
initRowsIfEmpty();
render();
startPolling();
</script>

<!-- 이하 부분: 클라우드, 차트, 색칠, 스냅샷 등 기존 코드 그대로 (생략 없이 유지) -->
<!-- (원본 파일의 나머지 <script> 블록들을 그대로 이어 붙이면 됩니다) -->
<!-- 여기서는 길이 때문에 생략하지만, 실제로는 당신이 쓰던 stock_dashboardc_test.html의 아래쪽 스크립트 전부를 이 위치에 그대로 두면 됩니다. -->

</body>
</html>
